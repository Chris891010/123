<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>跌倒管理系統 - 主控面板</title>
<script>
  // 防閃爍：在頁面載入前立即套用主題
  (function() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
    }
  })();
</script>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&family=Noto+Serif+TC:wght@700&display=swap" rel="stylesheet">

<!-- 共用樣式模組 -->
<link href="styles/theme-variables.css" rel="stylesheet">
<link href="styles/base.css" rel="stylesheet">
<link href="styles/buttons.css" rel="stylesheet">
<link href="styles/forms.css" rel="stylesheet">

<style>
/* #region index.html 專屬樣式 */

/* 導航標籤 */
nav.tabs {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin: 0.5rem 0 0;
}
.tab {
  border: 1px solid var(--line);
  background: var(--card-bg);
  color: var(--ink);
  border-radius: 999px;
  padding: 0.5rem 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.tab:hover {
  opacity: 0.8;
}

.tab.active {
  background: var(--brand);
  color: #ffffff;
  border-color: var(--brand);
}
/* #endregion */

/* #region 區塊樣式 */
.hero, .section {
  background: var(--card-bg);
  border: 1px solid var(--line);
  border-radius: 14px;
  padding: 14px;
  margin-top: 12px;
  color: var(--ink);
}

.section.management {
  background: var(--mgmt-50);
}

.section.tools {
  background: var(--tools-50);
}

.section.assessment {
  background: var(--ass-50);
}

.section.education {
  background: var(--edu-50);
}
/* #endregion */

/* #region 網格系統 */
.grid {
  display: grid;
  gap: 12px;
}

.grid.cols-4 {
  grid-template-columns: repeat(1, minmax(0, 1fr));
}

@media (min-width: 880px) {
  .grid.cols-4 {
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }
}
/* #endregion */

/* #region 卡片樣式 */
.card {
  background: var(--card-bg);
  border: 1px solid var(--line);
  border-radius: 14px;
  padding: 14px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  color: var(--ink);
}

.hide {
  display: none;
}
/* #endregion */

/* #region 開發日誌樣式 */
.changelog-entry {
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--shadow);
}

.changelog-entry:last-child {
  border-bottom: none;
  margin-bottom: 0;
}

.changelog-entry h4 {
  margin: 0 0 8px 0;
  color: var(--content);
  font-size: 16px;
}

.changelog-tags {
  margin-bottom: 12px;
}

.changelog-tags .badge {
  background: var(--info);
  color: white;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 11px;
  margin-right: 6px;
  font-weight: 500;
}

.roadmap-content h4 {
  margin: 16px 0 8px 0;
  color: var(--content);
  font-size: 14px;
}

.roadmap-content h4:first-child {
  margin-top: 0;
}

.error-message {
  color: var(--danger);
  text-align: center;
  padding: 20px;
}

.loading-message {
  text-align: center;
  padding: 20px;
  color: var(--content);
}

/* 表單與輸入 */
.row {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.search input,
input[type="text"],
input[type="date"],
input[type="number"],
select,
textarea {
  width: 100%;
  padding: 0.55rem 0.7rem;
  border: 1px solid var(--input-border);
  border-radius: 10px;
  background: var(--input-bg);
  color: var(--input-text);
}

fieldset.q {
  border: 1px solid var(--line);
  border-radius: 12px;
  padding: 10px 12px;
  margin: 10px 0;
  background: var(--card-bg);
  color: var(--ink);
}

.q legend {
  font-weight: 700;
  color: var(--ink);
}

.options {
  display: grid;
  grid-template-columns: repeat(5, minmax(90px, 1fr));
  gap: 0.45rem;
  margin-top: 0.35rem;
}

.opt {
  display: flex;
  gap: 0.35rem;
  align-items: center;
  border: 1px solid var(--line);
  border-radius: 10px;
  padding: 0.3rem 0.55rem;
  background: var(--card-bg);
  color: var(--ink);
}

/* 工具列與過濾器 */
.toolbar {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  margin: 0.5rem 0;
  flex-wrap: wrap;
}

.filter-pills {
  display: flex;
  gap: 0.35rem;
  flex-wrap: wrap;
}

.pill {
  border: 1px solid var(--line);
  background: var(--card-bg);
  color: var(--ink);
  border-radius: 999px;
  padding: 0.25rem 0.6rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.pill:hover {
  opacity: 0.8;
}

.pill.active {
  background: var(--brand);
  color: #ffffff;
  border-color: var(--brand);
}

/* 表格樣式 */
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  border: 1px solid var(--line);
  border-radius: 12px;
  overflow: hidden;
  background: var(--card-bg);
}

th, td {
  border-top: 1px solid var(--line);
  border-right: 1px solid var(--line);
  padding: 0.5rem 0.6rem;
  vertical-align: top;
  color: var(--ink);
}

th:last-child,
td:last-child {
  border-right: none;
}

thead th {
  background: var(--th-bg);
  font-weight: 700;
  color: var(--th-text);
}

tfoot td {
  background: var(--th-bg);
  color: var(--th-text);
}

/* 連結與徽章 */
a.inline {
  color: var(--link-color);
  text-decoration: none;
  border-bottom: 1px dashed var(--link-color);
}

a.inline:hover {
  color: var(--link-hover);
}

.badge {
  font-size: 0.78rem;
  border: 1px solid var(--line);
  border-radius: 999px;
  padding: 0.1rem 0.5rem;
  background: var(--card-bg);
  color: var(--ink);
}

.anchor {
  scroll-margin-top: 88px;
}

/* 開發日誌樣式 */
.changelog-content {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.changelog-entry {
  border-left: 4px solid var(--brand);
  padding-left: 16px;
  margin: 16px 0;
}

.changelog-entry h4 {
  margin: 0 0 8px 0;
  color: var(--ink);
  font-size: 1.1rem;
}

.changelog-tags {
  margin-bottom: 12px;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.changelog-entry ul {
  margin: 8px 0;
  padding-left: 20px;
}

.changelog-entry li {
  margin: 4px 0;
  line-height: 1.4;
}

.roadmap-content h4 {
  color: var(--brand);
  margin: 16px 0 8px 0;
  font-size: 1rem;
}

.roadmap-content ul {
  margin: 8px 0 20px 0;
  padding-left: 20px;
}

@media print{.tabs,.toolbar,.search,.filter-pills,.backonly,.hide-on-print{display:none!important}.container{max-width:none}}
/* #endregion */

</style>
</head>
<body>
<header class="container">
  <h1>跌倒管理 Frontpage</h1>
  <div class="small">BETA測試版</div>
  <nav class="tabs" role="tablist" aria-label="主選單">
    <button class="tab active" data-tab="home" aria-selected="true">概覽</button>
    <button class="tab" data-tab="roadmap" aria-selected="false">Roadmap</button>
    <button class="tab" data-tab="tools" aria-selected="false">工具庫</button>
    <button class="tab" data-tab="edu" aria-selected="false">教育訓練</button>
    <button class="tab" data-tab="qm" aria-selected="false">監測/成效</button>
    <button class="tab" data-tab="CGA" aria-selected="false">CGA表單測試 🔗</button>
    <button class="tab" data-tab="changelog" aria-selected="false">開發日誌</button>
    <span style="margin-left:auto"></span>
    <button class="btn" type="button" id="theme-toggle" title="切換主題">
      <span id="theme-icon">🌙</span>
    </button>
    <button class="btn" type="button" onclick="window.print()">列印</button>
  </nav>
</header>

<main class="container">
  <!-- 概覽 -->
  <section id="view-home" class="hero">
    <h2>請選擇你的角色</h2>
    <div class="grid cols-4">
      <div class="card"><h3>臨床人員</h3><div class="small">STRATIFY、Morse、環境巡檢、Post-Fall Huddle</div>
        <div class="row"><button class="btn" onclick="loadToolsModule('assessment')">量表</button></div>
      </div>
      <div class="card"><h3>跨專業團隊</h3><div class="small">RCA/改善、協作清單、CAM</div>
        <div class="row"><button class="btn" onclick="loadToolsModule('process')">協作工具</button></div>
      </div>
      <div class="card"><h3>單位 / 管理者</h3><div class="small">HSOPS、1B、1C、1E、<b>1F</b>、<b>2B QI</b></div>
        <div class="row">
          <button class="btn" onclick="loadToolsModule('assessment')">1B 利害關係人</button>
          <button class="btn" onclick="loadToolsModule('assessment')">1C 管理支持度</button>
          <button class="btn" onclick="loadToolsModule('assessment')">1E＋設備盤點</button>
          <button class="btn" onclick="loadToolsModule('assessment')">1F 準備度</button>
          <button class="btn" onclick="loadToolsModule('management')">2B 品質改善</button>
          <button class="btn" onclick="loadToolsModule('management')">2G 變革管理</button>
          <button class="btn" onclick="loadToolsModule('form')">3A 照護流程圖</button>
          <button class="btn" onclick="loadToolsModule('form')">3C 環境巡檢</button>
          <button class="btn" onclick="loadToolsModule('form')">3E 安全移位</button>
        </div>
      </div>
      <div class="card"><h3>病人 / 家屬</h3><div class="small">返家安全、居家環境檢核</div></div>
    </div>
  </section>

  <!-- Roadmap -->
  <section id="view-roadmap" class="section management hide">
    <h2>Roadmap（AHRQ）</h2>
    <div class="grid cols-4">
      <div class="card">
        <h3>Section 1 準備度</h3>
        <ul class="small">
          <li><a class="inline" href="javascript:void(0)" onclick="loadToolsModule('assessment')">1B 利害關係人</a></li>
          <li><a class="inline" href="javascript:void(0)" onclick="loadToolsModule('assessment')">1C 管理支持度</a></li>
          <li><a class="inline" href="javascript:void(0)" onclick="loadToolsModule('assessment')">1E 資源盤點（含 Smart Tech）</a></li>
          <li><a class="inline" href="javascript:void(0)" onclick="loadToolsModule('assessment')">1F 組織準備度</a></li>
        </ul>
      </div>
      <div class="card">
        <h3>Section 2 變革管理</h3>
        <ul class="small">
          <li><a class="inline" href="javascript:void(0)" onclick="loadToolsModule('management')">2B 品質改善流程（QI/PDCA）</a></li>
          <li><a class="inline" href="javascript:void(0)" onclick="loadToolsModule('management')">2G 變革管理檢核表</a></li>
        </ul>
      </div>
      <div class="card"><h3>Section 3 臨床實務</h3><ul class="small"><li><a class="inline" href="javascript:void(0)" onclick="loadToolsModule('form')">3A 住院病人跌倒照護流程圖</a></li><li><a class="inline" href="javascript:void(0)" onclick="loadToolsModule('form')">3C 床邊環境安全巡檢表</a></li><li><a class="inline" href="javascript:void(0)" onclick="loadToolsModule('form')">3E 安全移位臨床路徑</a></li></ul><div class="small">Morse / STRATIFY / CAM / Post-Fall</div></div>
      <div class="card"><h3>Section 4–6 導入/衡量/永續</h3><div class="small">PDSA、教育完成率、稽核</div></div>
    </div>
  </section>

  <!-- 工具庫 -->
  <section id="view-tools" class="section tools hide">
    <!-- 工具庫內容由模組動態生成 -->
  </section>

  <!-- 教育訓練 -->
  <section id="view-edu" class="section education hide">
    <h2>教育訓練</h2>
    <div class="grid cols-4">
      <div class="card"><h3>新人課</h3><div class="small">通用預防、量表、環境安全</div></div>
      <div class="card"><h3>年度複訓</h3><div class="small">KPI 回顧、Huddle 演練、PDSA</div></div>
      <div class="card"><h3>教材包</h3><div class="small">簡報/講義/題庫</div></div>
      <div class="card"><h3>2E 防跌知識測驗</h3><div class="small">多選題，自動計分</div><button class="btn" onclick="loadToolsModule('education')">開始測驗</button></div>
      <div class="card"><h3>HSOPS 文化調查</h3><div class="small">AHRQ 單位安全文化調查</div><button class="btn" onclick="loadToolsModule('education')">前往</button></div>
    </div>
  </section>

  <!-- 監測與成效 -->
  <section id="view-qm" class="section hide">
    <h2>監測與成效</h2>
    <div class="grid cols-4">
      <div class="card"><h3>跌倒率統計</h3><div class="small">月度/季度趨勢分析</div></div>
      <div class="card"><h3>傷害嚴重度</h3><div class="small">分級統計與根因分析</div></div>
      <div class="card"><h3>教育完成率</h3><div class="small">員工訓練完成度追蹤</div></div>
      <div class="card"><h3>HSOPS 文化指標</h3><div class="small">安全文化調查結果匯總</div></div>
    </div>
  </section>

  <!-- 開發日誌 -->
  <section id="view-changelog" class="section hide">
    <h2>開發日誌 📝</h2>
    
    <div id="changelog-loading" class="card">
      <div style="text-align: center; padding: 40px;">
        <div style="font-size: 24px; margin-bottom: 16px;">⏳</div>
        <div>載入開發日誌中...</div>
      </div>
    </div>
    
    <div id="changelog-error" class="card hide">
      <div style="text-align: center; padding: 40px; color: var(--danger-text);">
        <div style="font-size: 24px; margin-bottom: 16px;">❌</div>
        <div>開發日誌載入失敗</div>
        <button class="btn" onclick="loadChangelog()" style="margin-top: 16px;">重新載入</button>
      </div>
    </div>
    
    <div id="changelog-content" class="hide">
      <!-- 動態載入的內容將插入這裡 -->
    </div>
  </section>

<script>
/* ====== 下載 CSV ====== */
function downloadCSV(filename, text){
  const blob=new Blob(['\\ufeff'+text],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  const url=URL.createObjectURL(blob);
  a.href=url;a.download=filename;a.style.display='none';
  document.body.appendChild(a);a.click();a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),800);
}

/* ====== Tabs ====== */
function openTab(id){
  // CGA表單：在新分頁打開
  if (id === 'CGA') {
    window.open('CGA/CGA2.html', '_blank');
    return;
  }
  
  // 更新標籤狀態
  document.querySelectorAll('.tabs .tab').forEach(t=>{
    const on=t.dataset.tab===id;t.classList.toggle('active',on);t.setAttribute('aria-selected',String(on));
  });
  
  // 隱藏所有頁面
  document.querySelectorAll('main > section').forEach(s=>s.classList.add('hide'));
  
  // 顯示對應頁面
  if (id === 'tools') {
    // 工具庫：使用模組生成內容
    const toolsSection = document.getElementById('view-tools');
    toolsSection.classList.remove('hide');
    if (window.ToolsModuleAPI) {
      toolsSection.innerHTML = window.ToolsModuleAPI.generateContent();
    } else {
      toolsSection.innerHTML = '<div class="card"><h3>載入中...</h3></div>';
    }
  } else if (id === 'changelog') {
    // 開發日誌：顯示頁面並載入資料
    const changelogSection = document.getElementById('view-changelog');
    changelogSection.classList.remove('hide');
    
    // 如果是首次載入，自動載入資料
    const contentEl = document.getElementById('changelog-content');
    if (contentEl && (!contentEl.innerHTML.trim() || contentEl.innerHTML.includes('動態載入的內容將插入這裡'))) {
      loadChangelog();
    }
  } else {
    // 其他頁面：正常顯示
    (document.getElementById('view-'+id)||document.getElementById('view-home')).classList.remove('hide');
  }
  
  window.scrollTo({top:0,behavior:'smooth'});
}
document.querySelectorAll('.tabs .tab').forEach(t=>t.addEventListener('click',()=>openTab(t.dataset.tab)));

/* ====== 工具庫模組 ====== */
// 簡化版：直接載入工具庫
function loadToolsModule(filter = null) {
  openTab('tools');
  if (filter && window.ToolsModuleAPI) {
    // 如果有篩選條件，重新生成內容
    const toolsSection = document.getElementById('view-tools');
    toolsSection.innerHTML = window.ToolsModuleAPI.generateContent(filter);
  }
}





/* ====== Assessment 通用 ====== */
const ass=(function(){
  const getForm=id=>document.querySelector(`form[data-form-id="${id}"]`);
  const getKey=id=>`FRONT_${id}`;
  
  function toObj(id){
    const form=getForm(id),obj={};
    form.querySelectorAll('input,select,textarea').forEach(el=>{
      const n=el.name;if(!n)return;
      if(el.type==='radio'){if(el.checked)obj[n]=el.value;}
      else if(el.type==='checkbox')obj[n]=el.checked?'1':'';
      else obj[n]=el.value;
    });
    return obj;
  }
  
  function save(id){localStorage.setItem(getKey(id),JSON.stringify(toObj(id)));alert('已儲存');}
  
  function load(id){
    const raw=localStorage.getItem(getKey(id));if(!raw){alert('尚無資料');return}
    const data=JSON.parse(raw),form=getForm(id);
    form.querySelectorAll('input,select,textarea').forEach(el=>{
      const n=el.name;if(!(n in data))return;
      if(el.type==='radio')el.checked=(data[n]===el.value);
      else if(el.type==='checkbox')el.checked=!!data[n];
      else el.value=data[n];
    });
    if(id==='fk2e' && window.FK2E?.score)FK2E.score();
  }
  
  function clear(id){
    if(!confirm('清空本表單？'))return;
    const form=getForm(id);form.reset();
    form.querySelectorAll('input[type="radio"],input[type="checkbox"]').forEach(el=>el.checked=false);
  }
  
  function exportCSV(id){
    const obj=toObj(id),keys=Object.keys(obj);
    const csvRow=arr=>arr.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',');
    const csv=[csvRow(keys),csvRow(keys.map(k=>obj[k]??''))].join('\\r\\n');
    downloadCSV(`${id}.csv`,csv);
  }
  
  return {save,load,clear,exportCSV};
})();


/* ====== 初始化與事件 ====== */
// 監聽工具庫動作
document.addEventListener('toolsModuleAction', function(event) {
  const { action } = event.detail;
  if (action === 'backToTools') {
    openTab('tools');
  }
});

/* ====== 主題切換 ====== */
function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  document.getElementById('theme-icon').textContent = theme === 'dark' ? '☀️' : '🌙';
  localStorage.setItem('theme', theme);
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') || 'light';
  setTheme(current === 'dark' ? 'light' : 'dark');
}

function initTheme() {
  const saved = localStorage.getItem('theme');
  const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const theme = saved || (systemDark ? 'dark' : 'light');
  
  setTheme(theme);
  
  // 監聽系統主題變化
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!saved) setTheme(e.matches ? 'dark' : 'light');
  });
}

// 綁定主題切換按鈕
document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

// JS模組載入
function loadJSModuleChangelog() {
  const [loadingEl, contentEl, errorEl] = ['changelog-loading','changelog-content','changelog-error']
    .map(id => document.getElementById(id));
  
  if (window.ChangelogAPI) {
    renderChangelog(window.ChangelogAPI.getData());
    loadingEl?.classList.add('hide');
    errorEl?.classList.add('hide');
    contentEl?.classList.remove('hide');
  } else {
    setTimeout(() => {
      window.ChangelogAPI ? loadJSModuleChangelog() : showChangelogError('無法載入開發日誌模組');
    }, 500);
  }
}

// 渲染開發日誌內容
function renderChangelog(data) {
  const contentEl = document.getElementById('changelog-content');
  const html = `
    <div class="card">
      <h3>版本更新記錄</h3>
      <div class="changelog-content">
        ${data.releases.map(release => `
          <div class="changelog-entry">
            <h4>v${release.version} - ${release.date} - </h4>
            <div class="changelog-tags">
              ${release.tags.map(tag => `<span class="badge">${tag}</span>`).join('')}
            </div>
            <ul class="small">
              ${release.changes.map(change => `<li>${change}</li>`).join('')}
            </ul>
          </div>
        `).join('')}
      </div>
    </div>
    <div class="card">
      <h3>開發計畫</h3>
      <div class="roadmap-content">
        <h4>TODO清單</h4>
        <ul class="small">
          ${data.todoList.inProgress.map(item => `<li>${item}</li>`).join('')}
        </ul>
      </div>
    </div>
  `;
  contentEl.innerHTML = html;
}

// 顯示錯誤訊息
function showChangelogError(message) {
  const [loadingEl, errorEl, contentEl] = ['changelog-loading','changelog-error','changelog-content']
    .map(id => document.getElementById(id));
  
  const errorContent = errorEl?.querySelector('div');
  if (errorContent) {
    errorContent.innerHTML = `
      <div style="font-size: 24px; margin-bottom: 16px;">❌</div>
      <div>開發日誌載入失敗</div>
      <div style="font-size: 12px; margin-top: 8px; opacity: 0.7;">錯誤: ${message}</div>
      <button class="btn" onclick="loadChangelog()" style="margin-top: 16px;">重新載入</button>
      <button class="btn" onclick="loadJSModuleChangelog()" style="margin-top: 8px;">使用JS模組</button>`;
  }
  
  loadingEl?.classList.add('hide');
  contentEl?.classList.add('hide');
  errorEl?.classList.remove('hide');
}

async function loadChangelog() {
  const [loadingEl, errorEl, contentEl] = ['changelog-loading','changelog-error','changelog-content']
    .map(id => document.getElementById(id));
  
  // 顯示載入狀態
  loadingEl?.classList.remove('hide');
  errorEl?.classList.add('hide');
  contentEl?.classList.add('hide');
  
  // 優先使用JS模組
  if (window.ChangelogAPI) {
    renderChangelog(window.ChangelogAPI.getData());
    loadingEl?.classList.add('hide');
    contentEl?.classList.remove('hide');
    return;
  }
  
  // 嘗試fetch JSON
  try {
    const response = await fetch('./data/changelog.json');
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    renderChangelog(await response.json());
    loadingEl?.classList.add('hide');
    contentEl?.classList.remove('hide');
  } catch (error) {
    loadJSModuleChangelog();
  }
}

/* ====== 工具模組主題支援 ====== */
// 所有工具模組現在直接使用統一的全域CSS變數，不需要特殊處理

// 啟動系統
initTheme();
openTab('home');
</script>

<!-- 工具庫模組 -->
<script src="modules/tools-module.js"></script>
<!-- 開發日誌模組 -->
<script src="data/changelog.js"></script>
</body>
</html>