<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CGA – 全量表（修正版）</title>
<script>
  (function() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      document.documentElement.classList.add('dark');
    }
  })();
</script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet">
<link href="../styles/datepicker-theme.css" rel="stylesheet">

<!-- 共用樣式模組 -->
<link href="../styles/theme-variables.css" rel="stylesheet">
<link href="../styles/base.css" rel="stylesheet">
<link href="../styles/buttons.css" rel="stylesheet">
<link href="../styles/forms.css" rel="stylesheet">

<style>
/* #region CGA2.html 專屬樣式 */

/* 響應式網格 */
.grid {
  display: grid;
  gap: 20px;
}

  @media (min-width: 980px) {
    .grid.cols-2 {
      grid-template-columns: 1fr 380px;
    }
  }

  @media (max-width: 979px) {
    .container {
      padding: 16px;
    }
    
    h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
  }

  /* ========================================
     面板與卡片
     ======================================== */
  .panel {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .panel {
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
  }

  /* ========================================
     步驟導航條
     ======================================== */
  #stepbar {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin: 0 0 2rem;
    padding: 1.5rem 0;
    border-bottom: 2px solid var(--line);
  }

  .step {
    padding: 10px 20px;
    border: 2px solid var(--line);
    border-radius: 999px;
    background: var(--card-bg);
    color: var(--muted);
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .step:hover {
    border-color: var(--brand);
    color: var(--brand);
    background: var(--brand-50);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(29, 78, 216, 0.2);
  }

  .step.active {
    background: linear-gradient(135deg, var(--brand) 0%, #2563eb 100%);
    border-color: var(--brand);
    color: #ffffff;
    font-weight: 700;
    box-shadow: 0 4px 16px rgba(29, 78, 216, 0.4);
    transform: scale(1.05);
  }

  .step.active:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(29, 78, 216, 0.5);
  }

  /* ========================================
     控制區域
     ======================================== */
  .controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin: 1.5rem 0;
    padding-top: 1rem;
    border-top: 1px solid var(--line);
  }

  .hint {
    color: var(--muted);
    font-size: 0.875rem;
    line-height: 1.6;
    padding: 12px 16px;
    background: var(--info-light);
    border-radius: 8px;
    margin: 1rem 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  [data-theme="dark"] .hint {
    background: rgba(37, 99, 235, 0.15);
  }

  /* 頁面切換 */
  .page {
    display: none;
  }

  .page.show {
    display: block;
  }

  /* ========================================
     表單佈局系統
     ======================================== */
  .form {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 20px;
    margin: 1.5rem 0;
  }

  .field {
    grid-column: span 3;
    position: relative;
  }

  .col-2 {
    grid-column: span 2;
  }

  .col-4 {
    grid-column: span 4;
  }

  .col-6 {
    grid-column: span 6;
  }

  .col-8 {
    grid-column: span 8;
  }

  .col-12 {
    grid-column: span 12;
  }

  /* 響應式表單 */
  @media (max-width: 768px) {
    .form {
      gap: 12px;
    }
    
    .field,
    .col-2,
    .col-4,
    .col-6,
    .col-8 {
      grid-column: span 12;
    }
  }

  /* ========================================
     內容區塊
     ======================================== */
  .sec {
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 24px;
    margin: 1.5rem 0;
    background: var(--card-bg);
    box-shadow: 0 2px 8px var(--shadow);
    transition: box-shadow 0.3s ease, transform 0.3s ease;
  }

  .sec:hover {
    box-shadow: 0 4px 16px var(--shadow-lg);
    transform: translateY(-2px);
  }

  .sec h3 {
    margin: 0 0 1.25rem;
    padding-bottom: 0.875rem;
    border-bottom: 2px solid var(--line);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--ink);
    letter-spacing: 0.02em;
  }

  .sec:first-child {
    margin-top: 0;
  }

  .sec:last-child {
    margin-bottom: 0;
  }

  /* 標籤 */
  .badge {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    border: 2px solid var(--brand);
    background: var(--brand-50);
    color: var(--brand);
    padding: 0.25rem 0.75rem;
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.03em;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
  }

  .tag {
    display: inline-flex;
    align-items: center;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: var(--surface);
    color: var(--ink);
    padding: 0.35rem 0.75rem;
    margin: 0.3rem 0.35rem;
    font-size: 0.875rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    transition: all 0.2s ease;
  }

  .tag:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    transform: translateY(-1px);
  }

  /* 表格 */
  .table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 4px var(--shadow);
  }

  .table th,
  .table td {
    border-bottom: 1px solid var(--line);
    padding: 0.75rem 0.75rem;
    vertical-align: top;
  }

  .table thead th {
    background: var(--th-bg);
    color: var(--th-text);
    font-weight: 700;
    text-align: left;
    font-size: 0.875rem;
    letter-spacing: 0.02em;
  }

  .table tbody tr {
    transition: background-color 0.2s ease;
  }

  .table tbody tr:hover {
    background: var(--surface);
  }

  /* CCI chips - 改良避免重疊 */
  .cci-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .cci {
    min-width: 138px;
    max-width: 180px;
    padding: 0.45rem 0.6rem;
    border: 1px solid var(--line);
    border-radius: 20px;
    background: var(--card-bg);
    color: var(--ink);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  /* 輔助工具 */
  .helper h2 {
    margin: 0.2rem 0 0.5rem;
  }

  .helper .card {
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 0.75rem;
    margin: 0.6rem 0;
  }

  .tool a {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    text-decoration: none;
    color: var(--ink);
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 0.5rem 0.6rem;
    background: var(--surface);
  }

  .tool a:hover {
    background: var(--brand-50);
    border-color: var(--brand);
  }

  .pop {
    font-size: 0.85rem;
    color: #1e3a8a;
  }

  /* ========================================
     頁面標頭
     ======================================== */
  header {
    padding: 20px 0 12px 0;
    margin-bottom: 20px;
  }

  header .container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
  }

  header h1 {
    flex: 1;
    min-width: 200px;
    margin: 0;
    background: linear-gradient(135deg, var(--brand) 0%, #2563eb 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2rem;
  }

  /* 響應式調整（CGA 專屬） */
  @media (max-width: 768px) {
    header .container {
      gap: 12px;
    }
    
    header {
      padding-bottom: 8px;
      margin-bottom: 16px;
    }

    .panel {
      padding: 16px;
    }

    #stepbar {
      gap: 8px;
      margin-bottom: 1rem;
    }

    .step {
      padding: 6px 12px;
      font-size: 0.8125rem;
    }
  }
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>綜合老年評估（CGA）— 修正版</h1>
    <button class="btn" type="button" id="themeToggle" title="切換主題">
      <span id="themeIcon">🌙</span>
    </button>
  </div>
</header>

<main class="container grid cols-2">
  <!-- LEFT -->
  <section class="panel">
    <div id="stepbar"></div>

    <!-- 1 基本資料 -->
    <div class="page" data-title="基本資料">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 2 個人史 / 家系圖 / 重大疾病 / 功能回顧 / 跌倒記事 -->
    <div class="page" data-title="個人史/家系圖/功能回顧">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 3 ADL -->
    <div class="page" data-title="ADL（Barthel）">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 4 IADL -->
    <div class="page" data-title="IADL（Lawton）">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 5 Mini-Cog + CDT + MMSE -->
    <div class="page" data-title="Mini-Cog / MMSE">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 6 MoCA -->
    <div class="page" data-title="MoCA">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 7 GDS-5 / CAM / Braden -->
    <div class="page" data-title="GDS-5 / CAM / Braden">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 8 營養 -->
    <div class="page" data-title="營養（MNA-SF）">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 9 行動/肌少 -->
    <div class="page" data-title="行動/肌少（CHS）">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 10 跌倒評估 -->
    <div class="page" data-title="跌倒評估（STRATIFY / Morse）">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 11 B9 EQ-5D-3L / VAS -->
    <div class="page" data-title="B9 生活品質（EQ-5D-3L / VAS）">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 12 B11 嚴重度指數 -->
    <div class="page" data-title="B11 嚴重度指數">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 13 CCI -->
    <div class="page" data-title="CCI 共病指數">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 14 出院狀況 -->
    <div class="page" data-title="出院狀況">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 15 摘要/輸出 -->
    <div class="page" data-title="摘要 / 匯出">
      <!-- 表單內容將動態載入 -->
    </div>

    <div class="controls" style="justify-content:space-between">
      <button class="btn" id="prev">← 上一步</button>
      <div class="hint" id="stepLabel"></div>
      <button class="btn primary" id="next">下一步 →</button>
    </div>
  </section>

  <!-- RIGHT：工具 -->
  <aside class="panel helper">
    <h2>工具 & 連結</h2>
    <div class="card" id="tipBox"><div class="pop">依步驟顯示要點。</div></div>
    <div class="card">
      <h3>量表網站</h3>
      <div class="tool"><a href="https://www.mocatest.org/" target="_blank" rel="noopener">MoCA<span>官方</span></a></div>
      <div class="tool"><a href="https://www.parinc.com/Products/Pkey/238" target="_blank" rel="noopener">MMSE<span>PAR</span></a></div>
      <div class="tool"><a href="https://mini-cog.com" target="_blank" rel="noopener">Mini-Cog<span>指南</span></a></div>
      <div class="tool"><a href="https://www.icudelirium.org/medical-professionals/delirium/monitoring-delirium/cam-icudelirium" target="_blank" rel="noopener">CAM<span>譫妄</span></a></div>
      <div class="tool"><a href="https://www.stanford.edu/~yesavage/GDS.html" target="_blank" rel="noopener">GDS<span>老年憂鬱</span></a></div>
      <div class="tool"><a href="https://www.mna-elderly.com" target="_blank" rel="noopener">MNA-SF<span>營養</span></a></div>
      <div class="tool"><a href="https://www.cdc.gov/steadi/pdf/TUG_Test-print.pdf" target="_blank" rel="noopener">TUG<span>步態</span></a></div>
      <div class="tool"><a href="https://www.mdcalc.com/calc/3916/braden-scale-pressure-ulcer-risk" target="_blank" rel="noopener">Braden<span>壓傷</span></a></div>
    </div>
  </aside>
</main>

<!-- Flowbite JS -->
<script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>

<!-- Datepicker 初始化模組（包含中文化功能） -->
<script src="../tools/datepicker-init.js"></script>

<!-- 表單自動跳到下一欄工具 -->
<script src="../tools/form-auto-focus.js"></script>

<!-- 卡片式單選按鈕建構器 -->
<script src="../tools/card-radio-builder.js"></script>

<!-- 漸層說明框建構器 -->
<script src="../tools/info-box-builder.js"></script>

<!-- CGA 表單模組載入器（必須在主腳本之前載入） -->
<script src="cga-module-loader.js"></script>

<script>
(() => {
  const pages=[...document.querySelectorAll('.page')];
  let step=0;
  const stepbar=document.getElementById('stepbar');
  function renderSteps(){
    stepbar.innerHTML='';
    pages.forEach((p,i)=>{
      const b=document.createElement('button'); b.className='step'+(i===step?' active':''); b.textContent=(i+1)+'. '+p.dataset.title;
      b.onclick=()=>show(i); stepbar.appendChild(b);
    });
    document.getElementById('stepLabel').textContent=`第 ${step+1}/${pages.length} 步：${pages[step].dataset.title}`;
  }
  async function show(i){
    if(i<0||i>=pages.length) return;
    
    console.log(`📍 切換到頁面 ${i + 1}：${pages[i].dataset.title}`);
    
    // 切換顯示（模組已預先載入）
    pages.forEach((p,idx)=>p.classList.toggle('show',idx===i));
    step=i; 
    renderSteps(); 
    window.scrollTo({top:0,behavior:'smooth'});
    
    // 每次切換頁面時綁定事件和重新計算
    bindAllEvents();
    recomputeAll();
    
    console.log(`✅ 頁面切換完成`);
  }
  document.getElementById('prev').onclick=()=>show(step-1);
  document.getElementById('next').onclick=()=>show(step+1);

  // ==== Util
  const $=(s,root=document)=>root.querySelector(s);
  const $$=(s,root=document)=>Array.from(root.querySelectorAll(s));
  const nv=(el)=> (el?.value??'').trim();
  const num=(el)=>{ const v=parseFloat(nv(el)); return Number.isFinite(v)?v:null; };
  const tag=(wrap,txt)=>{ const t=document.createElement('span'); t.className='tag'; t.textContent=txt; wrap.appendChild(t); };

  // ==== BMI/IBW
  function syncAnthro(){
    const h=num($('#ht')), w=num($('#wt'));
    if(h&&w){ const m=h/100, bmi=w/(m*m), ibw=22*m*m; $('#bmi').value=bmi.toFixed(1); $('#ibw').value=ibw.toFixed(1); $('#ibwDiff').value=(w-ibw).toFixed(1); }
    else { $('#bmi').value=''; $('#ibw').value=''; $('#ibwDiff').value=''; }
    // 自動填充 MNA BMI 項目
    if (window.CGAForm08 && typeof window.CGAForm08.autoMNA_BMI === 'function') {
      window.CGAForm08.autoMNA_BMI();
    }
  }
  function bindAnthroEvents(){
    const ht = $('#ht'), wt = $('#wt');
    if(ht && wt) {
      ['input','change'].forEach(ev=>{
        ht.addEventListener(ev,syncAnthro);
        wt.addEventListener(ev,syncAnthro);
      });
    }
  }

  // ==== Family
  const fam={rows:[]};
  function bucket(role){ if(role==='父親'||role==='母親')return'Parent'; if(role==='配偶')return'Spouse'; if(role==='兄弟姊妹')return'Sibling'; if(role==='子女')return'Child'; return'Other'; }
  function renderFam(){
    const map={Parent:'#rowParent',Spouse:'#rowSpouse',Sibling:'#rowSibling',Child:'#rowChild',Other:'#rowOther'};
    // 檢查元素是否存在（表單可能尚未載入）
    const firstElement = $(Object.values(map)[0]);
    if (!firstElement) return; // 表單未載入時跳過
    
    Object.values(map).forEach(s=>{
      const el = $(s);
      if (el) el.innerHTML = '';
    });
    fam.rows.forEach((m,i)=>{
      const pill=document.createElement('span'); pill.className='tag'; pill.innerHTML=`${m.name||'（未名）'}・${m.sex||'?'}・${m.age||'?'}・${m.status||''} <small>${m.role}</small> <span style="color:#b91c1c;cursor:pointer" data-i="${i}">×</span>`;
      const target = $(map[bucket(m.role)]);
      if (target) target.appendChild(pill);
    });
    $$('#famRows span[data-i]').forEach(x=>x.onclick=()=>{ fam.rows.splice(+x.dataset.i,1); renderFam(); });
  }
  // addFam 事件綁定移至 bindAllEvents()

  // ==== Fall log
  const fall={list:[]};
  function renderFall(){ 
    const box=$('#fallList'); 
    if (!box) return; // 表單未載入時跳過
    box.innerHTML=''; 
    fall.list.forEach((e,i)=>{ 
      const pill=document.createElement('span'); 
      pill.className='tag'; 
      pill.innerHTML=`${e.date||''}・${e.place||''}・${e.context||''}・${e.outcome||''} <small>${e.note||''}</small> <span style="color:#b91c1c;cursor:pointer" data-i="${i}">×</span>`; 
      box.appendChild(pill); 
    }); 
    $$('#fallList span[data-i]').forEach(x=>x.onclick=()=>{ fam.rows.splice(+x.dataset.i,1); renderFall(); }); 
  }
  // addFall 事件綁定移至 bindAllEvents()

  // ==== 摘要 / 標籤
  function recomputeAll(){
    syncAnthro(); 
    
    // 使用模組的 compute 方法（已重構的模組）
    if (window.CGAForm03 && typeof window.CGAForm03.compute === 'function') {
      window.CGAForm03.compute();
    }
    if (window.CGAForm04 && typeof window.CGAForm04.compute === 'function') {
      window.CGAForm04.compute();
    }
    if (window.CGAForm05 && typeof window.CGAForm05.compute === 'function') {
      window.CGAForm05.compute();
    }
    if (window.CGAForm06 && typeof window.CGAForm06.compute === 'function') {
      window.CGAForm06.compute();
    }
    if (window.CGAForm07 && typeof window.CGAForm07.compute === 'function') {
      window.CGAForm07.compute();
    }
    if (window.CGAForm08 && typeof window.CGAForm08.compute === 'function') {
      window.CGAForm08.compute();
    }
    if (window.CGAForm09 && typeof window.CGAForm09.compute === 'function') {
      window.CGAForm09.compute();
    }
    if (window.CGAForm10 && typeof window.CGAForm10.compute === 'function') {
      window.CGAForm10.compute();
    }
    if (window.CGAForm12 && typeof window.CGAForm12.compute === 'function') {
      window.CGAForm12.compute();
    }
    if (window.CGAForm13 && typeof window.CGAForm13.compute === 'function') {
      window.CGAForm13.compute();
    }
    
    // 標籤
    const box=$('#riskTags'); 
    if (!box) return; // 摘要頁未載入時跳過
    box.innerHTML='';
    const gds=+$('#gdsTotal').textContent||0; if(gds>=2) tag(box,'GDS-5 ≥2');
    const cam=nv($('#camResult')); if(cam==='譫妄') tag(box,'CAM 譫妄');
    const br=+$('#bradenTotal').textContent||0; if(br && br<=12) tag(box,'Braden 高風險');
    const mna=+$('#mnaTotal').textContent||0; if(mna<=7) tag(box,'MNA-SF 營養不良'); else if(mna<=11) tag(box,'MNA-SF 風險');
    const chs=+$('#chsTotal').textContent||0; if(chs>=3) tag(box,'CHS 衰弱'); else if(chs>=1) tag(box,'CHS 前衰弱');
    const morse=+$('#morseTotal').textContent||0; if(morse>=46) tag(box,'Morse ≥46 高跌倒風險');
    const mmse=+$('#mmseTotal').textContent||0; if(mmse && mmse<=23) tag(box,'MMSE ≤23');
    const moca=+$('#mocaTotal').textContent||0; if(moca && moca<26) tag(box,'MoCA <26');
    const adl=+$('#adlTotal').textContent||0; if(adl<=60) tag(box,'ADL ≤60');
    const cci=+$('#cciTotal').textContent||0; if(cci>=5) tag(box,'CCI ≥5');
    // 摘要
    const nm=nv($('#pname'))||'個案', age=nv($('#age'))||'?', sex=nv($('#sex'))||'';
    const sum=`${nm}（${age}歲${sex}）。ADL ${adl}/100；IADL ${$('#iadlTotal').textContent}/${$('#iadlMax').textContent}；Mini-Cog ${$('#miniTotal').value||'NA'}/5（${nv($('#miniBinary'))||'NA'}）；MMSE ${mmse||'NA'}/30；MoCA ${moca||'NA'}/30；GDS-5 ${gds}/5；MNA-SF ${mna}/14；步速 ${nv($('#gaitSpeed'))||'NA'} m/s；TUG ${nv($('#tug'))||'NA'} s；握力最大 ${nv($('#gripMax'))||'NA'} kg；CFS ${nv($('#cfs'))||'NA'}；STRATIFY ${$('#stratifyTotal').textContent}；Morse ${morse}；EQ-VAS ${nv($('#eqVASVal'))||'NA'}；CCI ${cci}；出院：${nv($('#dcDest'))||'NA'}。`;
    $('#summary').value=sum;
  }

  // ==== Storage / Export
  function snapshot(){
    const data={};
    $$('input,select,textarea').forEach(el=>{
      const key=el.id||el.name||el.getAttribute('data-k'); if(!key) return;
      if(el.type==='radio'){ if(el.checked) data[key]=el.value; }
      else if(el.type==='checkbox'){ data[key]=el.checked; }
      else data[key]=el.value;
    });
    data['fam']=JSON.stringify(fam.rows); data['falls']=JSON.stringify(fall.list);
    return data;
  }
  function loadshot(obj){
    $$('input,select,textarea').forEach(el=>{
      const key=el.id||el.name||el.getAttribute('data-k'); if(!(key in obj)) return;
      if(el.type==='checkbox') el.checked=!!obj[key];
      else if(el.type==='radio') { if(el.value==obj[key]) el.checked=true; }
      else el.value=obj[key];
    });
    try{ fam.rows=JSON.parse(obj.fam||'[]'); }catch{}
    try{ fall.list=JSON.parse(obj.falls||'[]'); }catch{}
    renderFam(); renderFall(); recomputeAll();
  }
  
  // ==== 統一事件綁定函數
  let eventsBindingInitialized = false;
  
  function bindAllEvents() {
    // 初始化所有動態表單（調用模組的 initialize 方法）
    // 只初始化已載入的模組
    if (window.CGAForm01 && typeof window.CGAForm01.initialize === 'function') {
      window.CGAForm01.initialize();
    }
    if (window.CGAForm03 && typeof window.CGAForm03.initialize === 'function') {
      window.CGAForm03.initialize();
    }
    if (window.CGAForm04 && typeof window.CGAForm04.initialize === 'function') {
      window.CGAForm04.initialize();
    }
    if (window.CGAForm07 && typeof window.CGAForm07.initialize === 'function') {
      window.CGAForm07.initialize();
    }
    if (window.CGAForm08 && typeof window.CGAForm08.initialize === 'function') {
      window.CGAForm08.initialize();
    }
    if (window.CGAForm10 && typeof window.CGAForm10.initialize === 'function') {
      window.CGAForm10.initialize();
    }
    if (window.CGAForm11 && typeof window.CGAForm11.initialize === 'function') {
      window.CGAForm11.initialize();
    }
    if (window.CGAForm13 && typeof window.CGAForm13.initialize === 'function') {
      window.CGAForm13.initialize();
    }
    
    // 基本資料頁的事件
    bindAnthroEvents();
    
    // 家系圖和跌倒事件
    const addFam = $('#addFam');
    if (addFam) {
      addFam.onclick = () => {
        const m={role:nv($('#famRole')),name:nv($('#famName')),sex:nv($('#famSex')),age:nv($('#famAge')),status:nv($('#famStatus')),dx:nv($('#famDx'))};
        if(!m.role) return alert('請選角色'); fam.rows.push(m);
        ['famRole','famName','famSex','famAge','famStatus','famDx'].forEach(id=>$('#'+id).value=''); renderFam();
      };
    }
    
    const addFall = $('#addFall');
    if (addFall) {
      addFall.onclick = () => { 
        const e={date:nv($('#feDate')),place:nv($('#fePlace')),context:nv($('#feCtx')),outcome:nv($('#feOut')),note:nv($('#feNote'))}; 
        if(!e.date && !e.place) return alert('請至少填 日期或地點'); 
        fall.list.push(e); 
        ['feDate','fePlace','feCtx','feOut','feNote'].forEach(id=>$('#'+id).value=''); 
        renderFall(); 
      };
    }
    
    // 摘要頁的事件（這些按鈕只綁定一次）
    if (!eventsBindingInitialized) {
      const recalc = $('#recalc');
      if (recalc) recalc.onclick = recomputeAll;
      
      const save = $('#save');
      if (save) save.onclick = () => { localStorage.setItem('cga_full', JSON.stringify(snapshot())); alert('已儲存'); };
      
      const load = $('#load');
      if (load) load.onclick = () => { const raw=localStorage.getItem('cga_full'); if(!raw) return alert('尚無資料'); loadshot(JSON.parse(raw)); };
      
      const clear = $('#clear');
      if (clear) clear.onclick = () => { if(confirm('清除所有內容？')){ localStorage.removeItem('cga_full'); location.reload(); } };
      
      const exportJson = $('#exportJson');
      if (exportJson) exportJson.onclick = () => { const blob=new Blob([JSON.stringify(snapshot(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cga.json'; a.click(); };
      
      const exportCsv = $('#exportCsv');
      if (exportCsv) exportCsv.onclick = () => { const obj=snapshot(); const keys=Object.keys(obj); const row=keys.map(k=>JSON.stringify(obj[k]??'')).join(','); const csv=keys.join(',')+'\n'+row+'\n'; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='cga.csv'; a.click(); };
      
      // IADL 男性跳過選項
      const iadlMaleSkip = $('#iadlMaleSkip');
      if (iadlMaleSkip) iadlMaleSkip.onchange = () => {
        if (window.CGAForm04 && typeof window.CGAForm04.compute === 'function') {
          window.CGAForm04.compute();
        }
      };
      
      eventsBindingInitialized = true;
    }
  }

  // ==== Wiring（全域事件）
  document.addEventListener('change',recomputeAll,true);
  document.addEventListener('input',recomputeAll,true);

  // 初始化（預先載入所有表單模組）
  (async function init() {
    renderSteps(); renderFam(); renderFall();
    
    // 確保 CGAModuleLoader 已載入
    if (!window.CGAModuleLoader) {
      console.error('❌ CGAModuleLoader 尚未載入！');
      alert('載入器初始化失敗，請重新整理頁面');
      return;
    }
    
    console.log('🚀 開始預先載入所有表單模組...');
    
    // 預先載入所有 15 個表單模組
    const totalModules = pages.length;
    for (let i = 0; i < totalModules; i++) {
      try {
        console.log(`📦 載入模組 ${i + 1}/${totalModules}...`);
        await window.CGAModuleLoader.loadModule(i);
        console.log(`✅ 模組 ${i + 1} 載入完成`);
      } catch (error) {
        console.error(`❌ 載入模組 ${i + 1} 失敗:`, error);
        // 繼續載入其他模組，不中斷
      }
    }
    
    console.log('✅ 所有表單模組載入完成！');
    
    // 顯示第一個頁面
    pages.forEach((p, idx) => p.classList.toggle('show', idx === 0));
    step = 0;
    renderSteps();
    
    // 綁定所有事件
    bindAllEvents();
    recomputeAll();
    
    console.log('✅ 初始化完成');
  })();

  // ==== 主題切換功能（與 index.html 共享設定）
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  const htmlElement = document.documentElement;
  
  // 同步主題圖示（主題已在 <head> 中套用）
  const currentTheme = htmlElement.getAttribute('data-theme');
  if (themeIcon) {
    themeIcon.textContent = currentTheme === 'dark' ? '☀️' : '🌙';
  }
  
  // 主題切換事件
  if (themeToggle) {
    themeToggle.addEventListener('click', () => {
      const currentTheme = htmlElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      // 更新自訂屬性
      htmlElement.setAttribute('data-theme', newTheme);
      
      // 更新 Flowbite 需要的 dark class
      if (newTheme === 'dark') {
        htmlElement.classList.add('dark');
      } else {
        htmlElement.classList.remove('dark');
      }
      
      themeIcon.textContent = newTheme === 'dark' ? '☀️' : '🌙';
      // 使用與 index.html 相同的 key，實現跨頁面主題記憶
      localStorage.setItem('theme', newTheme);
    });
  }
})();
</script>

</body>
</html>
