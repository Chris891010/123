<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CGA – 全量表（修正版）</title>
<script>
  (function() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      document.documentElement.classList.add('dark');
    }
  })();
</script>

<!-- 字體（本地優先，CDN 備援） -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">

<!-- 共用樣式模組（基礎優先） -->
<link href="../styles/theme-variables.css" rel="stylesheet">
<link href="../styles/base.css?v=2024100501" rel="stylesheet">
<link href="../styles/buttons.css" rel="stylesheet">
    <link href="../styles/forms.css?v=2024100507" rel="stylesheet"><!-- Flowbite (本地化完整版) -->
<link href="../styles/flowbite.min.css" rel="stylesheet">
<link href="../styles/datepicker-theme.css" rel="stylesheet">

<style>
/* #region CGA2.html 專屬樣式 */

/* 響應式網格 */
.grid {
  display: grid;
  gap: 20px;
}

  @media (min-width: 980px) {
    .grid.cols-2 {
      grid-template-columns: 1fr 380px;
    }
  }

  @media (max-width: 979px) {
    .container {
      padding: 16px;
    }
    
    h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
  }

  /* ========================================
     面板與卡片
     ======================================== */
  .panel {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .panel {
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
  }

  /* ========================================
     步驟導航條
     ======================================== */
  #stepbar {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin: 0 0 2rem;
    padding: 1.5rem 0;
    border-bottom: 2px solid var(--line);
  }

  .step {
    padding: 10px 20px;
    border: 2px solid var(--line);
    border-radius: 999px;
    background: var(--card-bg);
    color: var(--muted);
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .step:hover {
    border-color: var(--brand);
    color: var(--brand);
    background: var(--brand-50);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(29, 78, 216, 0.2);
  }

  .step.active {
    background: linear-gradient(135deg, var(--brand) 0%, #2563eb 100%);
    border-color: var(--brand);
    color: #ffffff;
    font-weight: 700;
    box-shadow: 0 4px 16px rgba(29, 78, 216, 0.4);
    transform: scale(1.05);
  }

  .step.active:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(29, 78, 216, 0.5);
  }

  /* ========================================
     控制區域
     ======================================== */
  .controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin: 1.5rem 0;
    padding-top: 1rem;
    border-top: 1px solid var(--line);
  }

  .hint {
    color: var(--muted);
    font-size: 0.875rem;
    line-height: 1.6;
    padding: 12px 16px;
    background: var(--info-light);
    border-radius: 8px;
    margin: 1rem 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  [data-theme="dark"] .hint {
    background: rgba(37, 99, 235, 0.15);
  }

  /* 頁面切換 */
  .page {
    display: none;
  }

  .page.show {
    display: block;
  }

  /* ========================================
     表單佈局系統
     ======================================== */
  .form {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 20px;
    margin: 1.5rem 0;
  }

  .field {
    grid-column: span 3;
    position: relative;
  }

  .col-2 {
    grid-column: span 2;
  }

  .col-4 {
    grid-column: span 4;
  }

  .col-6 {
    grid-column: span 6;
  }

  .col-8 {
    grid-column: span 8;
  }

  .col-12 {
    grid-column: span 12;
  }

  /* 響應式表單 */
  @media (max-width: 768px) {
    .form {
      gap: 12px;
    }
    
    .field,
    .col-2,
    .col-4,
    .col-6,
    .col-8 {
      grid-column: span 12;
    }
  }

  /* ========================================
     內容區塊
     ======================================== */
  .sec {
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 24px;
    margin: 1.5rem 0;
    background: var(--card-bg);
    box-shadow: 0 2px 8px var(--shadow);
  }

  .sec h3 {
    margin: 0 0 1.25rem;
    padding-bottom: 0.875rem;
    border-bottom: 2px solid var(--line);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--ink);
    letter-spacing: 0.02em;
  }

  .sec:first-child {
    margin-top: 0;
  }

  .sec:last-child {
    margin-bottom: 0;
  }

  /* 標籤 */
  .badge {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    border: 2px solid var(--brand);
    background: var(--brand-50);
    color: var(--brand);
    padding: 0.25rem 0.75rem;
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.03em;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
  }

  .tag {
    display: inline-flex;
    align-items: center;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: var(--surface);
    color: var(--ink);
    padding: 0.35rem 0.75rem;
    margin: 0.3rem 0.35rem;
    font-size: 0.875rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    transition: all 0.2s ease;
  }

  .tag:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    transform: translateY(-1px);
  }

  /* 表格 */
  .table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 4px var(--shadow);
  }

  .table th,
  .table td {
    border-bottom: 1px solid var(--line);
    padding: 0.75rem 0.75rem;
    vertical-align: top;
  }

  .table thead th {
    background: var(--th-bg);
    color: var(--th-text);
    font-weight: 700;
    text-align: left;
    font-size: 0.875rem;
    letter-spacing: 0.02em;
  }

  .table tbody tr {
    transition: background-color 0.2s ease;
  }

  .table tbody tr:hover {
    background: var(--surface);
  }

  /* CCI chips - 改良避免重疊 */
  .cci-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .cci {
    min-width: 138px;
    max-width: 180px;
    padding: 0.45rem 0.6rem;
    border: 1px solid var(--line);
    border-radius: 20px;
    background: var(--card-bg);
    color: var(--ink);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  /* 輔助工具 */
  .helper h2 {
    margin: 0.2rem 0 0.5rem;
  }

  .helper .card {
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 0.75rem;
    margin: 0.6rem 0;
  }

  .tool a {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    color: var(--ink);
    border: 2px solid var(--line);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    background: var(--surface);
    transition: all 0.2s ease;
    font-size: 0.9375rem;
  }

  .tool a:hover {
    background: var(--brand-50);
    border-color: var(--brand);
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .pop {
    font-size: 0.85rem;
    color: #1e3a8a;
  }

  /* ========================================
     頁面標頭
     ======================================== */
  header {
    padding: 20px 0 12px 0;
    margin-bottom: 20px;
  }

  header .container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
  }

  header h1 {
    flex: 1;
    min-width: 200px;
    margin: 0;
    background: linear-gradient(135deg, var(--brand) 0%, #2563eb 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2rem;
  }

  /* 響應式調整（CGA 專屬） */
  @media (max-width: 768px) {
    header .container {
      gap: 12px;
    }
    
    header {
      padding-bottom: 8px;
      margin-bottom: 16px;
    }

    .panel {
      padding: 16px;
    }

    #stepbar {
      gap: 8px;
      margin-bottom: 1rem;
    }

    .step {
      padding: 6px 12px;
      font-size: 0.8125rem;
    }
  }
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>綜合老年評估（CGA）— 修正版</h1>
    <button class="btn" type="button" id="themeToggle" title="切換主題">
      <span id="themeIcon">🌙</span>
    </button>
  </div>
</header>

<main class="container grid cols-2">
  <!-- LEFT -->
  <section class="panel">
    <div id="stepbar"></div>

    <!-- 1 基本資料 -->
    <div class="page" data-title="基本資料">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 2 個人史 / 家系圖 / 重大疾病 / 功能回顧 / 跌倒記事 -->
    <div class="page" data-title="個人史/家系圖/功能回顧">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 3 ADL -->
    <div class="page" data-title="ADL（Barthel）">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 4 IADL -->
    <div class="page" data-title="IADL（Lawton）">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 5 Mini-Cog + CDT + MMSE -->
    <div class="page" data-title="Mini-Cog / MMSE">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 6 MoCA -->
    <div class="page" data-title="MoCA">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 7 GDS-5 / CAM / Braden -->
    <div class="page" data-title="GDS-5 / CAM / Braden">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 8 營養 -->
    <div class="page" data-title="營養（MNA-SF）">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 9 行動/肌少 -->
    <div class="page" data-title="行動/肌少（CHS）">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 10 跌倒評估 -->
    <div class="page" data-title="跌倒評估（STRATIFY / Morse）">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 11 B9 EQ-5D-3L / VAS -->
    <div class="page" data-title="B9 生活品質（EQ-5D-3L / VAS）">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 12 B11 嚴重度指數 -->
    <div class="page" data-title="B11 嚴重度指數">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 13 CCI -->
    <div class="page" data-title="CCI 共病指數">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 14 出院狀況 -->
    <div class="page" data-title="出院狀況">
      <!-- 表單內容將動態載入 -->
    </div>

    <!-- 15 摘要/輸出 -->
    <div class="page" data-title="摘要 / 匯出">
      <!-- 表單內容將動態載入 -->
    </div>

    <div class="controls" style="justify-content:space-between">
      <button class="btn" id="prev">← 上一步</button>
      <div class="hint" id="stepLabel"></div>
      <button class="btn primary" id="next">下一步 →</button>
    </div>
  </section>

  <!-- RIGHT：工具 -->
  <aside class="panel helper">
    <h2>🔗 工具與資源</h2>
    
    <!-- 量表網站 -->
    <div class="card">
      <h3 style="font-size: 1rem; font-weight: 700; color: var(--brand); margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--line);">
        📚 量表官方網站
      </h3>
      
      <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        <!-- 認知評估工具 -->
        <div style="margin-bottom: 0.75rem;">
          <div style="font-size: 0.8125rem; font-weight: 600; color: var(--muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
            🧠 認知評估
          </div>
          <div class="tool">
            <a href="https://www.mocatest.org/" target="_blank" rel="noopener">
              <span style="font-weight: 600;">MoCA</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">官方網站</span>
            </a>
          </div>
          <div class="tool">
            <a href="https://www.parinc.com/Products/Pkey/238" target="_blank" rel="noopener">
              <span style="font-weight: 600;">MMSE</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">PAR Inc</span>
            </a>
          </div>
          <div class="tool">
            <a href="https://mini-cog.com" target="_blank" rel="noopener">
              <span style="font-weight: 600;">Mini-Cog</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">使用指南</span>
            </a>
          </div>
        </div>
        
        <!-- 精神心理工具 -->
        <div style="margin-bottom: 0.75rem;">
          <div style="font-size: 0.8125rem; font-weight: 600; color: var(--muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
            🧘 精神狀態
          </div>
          <div class="tool">
            <a href="https://www.icudelirium.org/medical-professionals/delirium/monitoring-delirium/cam-icudelirium" target="_blank" rel="noopener">
              <span style="font-weight: 600;">CAM</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">譫妄評估</span>
            </a>
          </div>
          <div class="tool">
            <a href="https://www.stanford.edu/~yesavage/GDS.html" target="_blank" rel="noopener">
              <span style="font-weight: 600;">GDS</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">老年憂鬱</span>
            </a>
          </div>
        </div>
        
        <!-- 功能與風險工具 -->
        <div>
          <div style="font-size: 0.8125rem; font-weight: 600; color: var(--muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
            ⚕️ 功能評估
          </div>
          <div class="tool">
            <a href="https://www.mna-elderly.com" target="_blank" rel="noopener">
              <span style="font-weight: 600;">MNA-SF</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">營養篩檢</span>
            </a>
          </div>
          <div class="tool">
            <a href="https://www.cdc.gov/steadi/pdf/TUG_Test-print.pdf" target="_blank" rel="noopener">
              <span style="font-weight: 600;">TUG</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">步態平衡</span>
            </a>
          </div>
          <div class="tool">
            <a href="https://www.mdcalc.com/calc/3916/braden-scale-pressure-ulcer-risk" target="_blank" rel="noopener">
              <span style="font-weight: 600;">Braden</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">壓傷風險</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </aside>
</main>

<!-- Flowbite JS (本地化) -->
<script src="../tools/flowbite.min.js"></script>

<!-- Datepicker 初始化模組（包含中文化功能） -->
<script src="../tools/date-picker-helper.js"></script>

<!-- 事件總線 - 模組間通訊 -->
<script src="../tools/event-bus.js"></script>

<!-- 自動跳到下一欄工具 -->
<script src="../tools/auto-next-field.js"></script>

<!-- 選擇題卡片建構器 -->
<script src="../tools/choice-card-builder.js"></script>

<!-- 下拉選單建構器 -->
<script src="../tools/dropdown-builder.js"></script>

<!-- 訊息框建構器 -->
<script src="../tools/message-box-builder.js"></script>

<!-- CGA 表單模組載入器（必須在主腳本之前載入） -->
<script src="cga-module-loader.js"></script>

<script>
(() => {
  // ========================================
  // 全域變數
  // ========================================
  const pages = [...document.querySelectorAll('.page')];
  let step = 0;
  const stepbar = document.getElementById('stepbar');
  
  // 使用 Form 02 提供的管理器工廠方法
  let fam, fall;

  // ========================================
  // 頁面導航
  // ========================================
  function renderSteps() {
    stepbar.innerHTML = '';
    pages.forEach((p, i) => {
      const b = document.createElement('button');
      b.className = 'step' + (i === step ? ' active' : '');
      b.textContent = (i + 1) + '. ' + p.dataset.title;
      b.onclick = () => show(i);
      stepbar.appendChild(b);
    });
    document.getElementById('stepLabel').textContent = 
      `第 ${step + 1}/${pages.length} 步：${pages[step].dataset.title}`;
  }

  async function show(i) {
    if (i < 0 || i >= pages.length) return;
    
    console.log(`📍 切換到頁面 ${i + 1}：${pages[i].dataset.title}`);
    
    // 切換顯示（模組已預先載入）
    pages.forEach((p, idx) => p.classList.toggle('show', idx === i));
    step = i;
    renderSteps();
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // 每次切換頁面時綁定事件和重新計算
    bindAllEvents();
    recomputeAll();
    
    console.log(`✅ 頁面切換完成`);
  }

  document.getElementById('prev').onclick = () => show(step - 1);
  document.getElementById('next').onclick = () => show(step + 1);

  // ========================================
  // 工具函數
  // ========================================
  const $ = (s, root = document) => root.querySelector(s);
  const $$ = (s, root = document) => Array.from(root.querySelectorAll(s));
  const nv = (el) => (el?.value ?? '').trim();
  const num = (el) => {
    const v = parseFloat(nv(el));
    return Number.isFinite(v) ? v : null;
  };
  const tag = (wrap, txt) => {
    const t = document.createElement('span');
    t.className = 'tag';
    t.textContent = txt;
    wrap.appendChild(t);
  };

  // ========================================
  // 資料摘要與計算
  // ========================================
  function recomputeAll() {
    // 調用 Form 01 的 BMI 計算
    if (window.CGAForm01 && typeof window.CGAForm01.syncAnthro === 'function') {
      window.CGAForm01.syncAnthro();
    }
    
    // 調用各模組的計算方法
    const modules = [
      'CGAForm03', 'CGAForm04', 'CGAForm05', 'CGAForm06',
      'CGAForm07', 'CGAForm08', 'CGAForm09', 'CGAForm10',
      'CGAForm11', 'CGAForm12', 'CGAForm13'
    ];
    
    modules.forEach(moduleName => {
      if (window[moduleName] && typeof window[moduleName].compute === 'function') {
        window[moduleName].compute();
      }
    });
    
    // 標籤（只在摘要頁存在時執行）
    const box = $('#riskTags');
    if (!box) return;
    
    box.innerHTML = '';
    
    // 安全讀取元素（避免 null 錯誤）
    const safeText = (selector) => {
      const el = $(selector);
      return el ? (el.textContent || '0') : '0';
    };
    
    // 風險標籤
    const gds = +safeText('#gdsTotal');
    if (gds >= 2) tag(box, 'GDS-5 ≥2');
    
    const cam = nv($('#camResult'));
    if (cam === '譫妄') tag(box, 'CAM 譫妄');
    
    const br = +safeText('#bradenTotal');
    if (br && br <= 12) tag(box, 'Braden 高風險');
    
    const mna = +safeText('#mnaTotal');
    if (mna <= 7) tag(box, 'MNA-SF 營養不良');
    else if (mna <= 11) tag(box, 'MNA-SF 風險');
    
    const chs = +safeText('#chsTotal');
    if (chs >= 3) tag(box, 'CHS 衰弱');
    else if (chs >= 1) tag(box, 'CHS 前衰弱');
    
    const morse = +safeText('#morseTotal');
    if (morse >= 46) tag(box, 'Morse ≥46 高跌倒風險');
    
    const mmse = +safeText('#mmseTotal');
    if (mmse && mmse <= 23) tag(box, 'MMSE ≤23');
    
    const moca = +safeText('#mocaTotal');
    if (moca && moca < 26) tag(box, 'MoCA <26');
    
    const adl = +safeText('#adlTotal');
    if (adl <= 60) tag(box, 'ADL ≤60');
    
    const cci = +safeText('#cciTotal');
    if (cci >= 5) tag(box, 'CCI ≥5');
    
    // 摘要文字
    const nm = nv($('#pname')) || '個案';
    const age = nv($('#age')) || '?';
    const sex = nv($('#sex')) || '';
    const iadlTotal = safeText('#iadlTotal');
    const iadlMax = safeText('#iadlMax');
    const stratifyTotal = safeText('#stratifyTotal');
    
    const sum = `${nm}（${age}歲${sex}）。ADL ${adl}/100；IADL ${iadlTotal}/${iadlMax}；Mini-Cog ${$('#miniTotal')?.value || 'NA'}/5（${nv($('#miniBinary')) || 'NA'}）；MMSE ${mmse || 'NA'}/30；MoCA ${moca || 'NA'}/30；GDS-5 ${gds}/5；MNA-SF ${mna}/14；步速 ${nv($('#gaitSpeed')) || 'NA'} m/s；TUG ${nv($('#tug')) || 'NA'} s；握力最大 ${nv($('#gripMax')) || 'NA'} kg；CFS ${nv($('#cfs')) || 'NA'}；STRATIFY ${stratifyTotal}；Morse ${morse}；EQ-VAS ${nv($('#eqVASVal')) || 'NA'}；CCI ${cci}；出院：${nv($('#dcDest')) || 'NA'}。`;
    
    const summaryEl = $('#summary');
    if (summaryEl) summaryEl.value = sum;
  }

  // ========================================
  // 資料儲存與匯出
  // ========================================
  function snapshot() {
    const data = {};
    
    $$('input, select, textarea').forEach(el => {
      const key = el.id || el.name || el.getAttribute('data-k');
      if (!key) return;
      
      if (el.type === 'radio') {
        if (el.checked) data[key] = el.value;
      } else if (el.type === 'checkbox') {
        data[key] = el.checked;
      } else {
        data[key] = el.value;
      }
    });
    
    data['fam'] = JSON.stringify(fam.rows);
    data['falls'] = JSON.stringify(fall.list);
    
    return data;
  }

  function loadshot(obj) {
    $$('input, select, textarea').forEach(el => {
      const key = el.id || el.name || el.getAttribute('data-k');
      if (!(key in obj)) return;
      
      if (el.type === 'checkbox') {
        el.checked = !!obj[key];
      } else if (el.type === 'radio') {
        if (el.value == obj[key]) el.checked = true;
      } else {
        el.value = obj[key];
      }
    });
    
    try {
      fam.rows = JSON.parse(obj.fam || '[]');
    } catch {}
    
    try {
      fall.list = JSON.parse(obj.falls || '[]');
    } catch {}
    
    fam.render();
    fall.render();
    recomputeAll();
  }

  // ========================================
  // 統一事件綁定
  // ========================================
  function bindAllEvents() {
    // 初始化所有已載入的動態表單模組
    const formModules = [
      'CGAForm01', 'CGAForm02', 'CGAForm03', 'CGAForm04',
      'CGAForm06', 'CGAForm07', 'CGAForm08', 'CGAForm09', 'CGAForm10',
      'CGAForm11', 'CGAForm13', 'CGAForm14', 'CGAForm15'
    ];
    
    formModules.forEach(moduleName => {
      if (window[moduleName] && typeof window[moduleName].initialize === 'function') {
        window[moduleName].initialize();
      }
    });
  }
  
  // ========================================
  // 事件訂閱 - 監聽模組發送的事件
  // ========================================
  function subscribeToEvents() {
    if (!window.CGAEventBus) {
      console.warn('⚠️ 事件總線尚未初始化');
      return;
    }
    
    // 訂閱家系圖新增事件
    window.CGAEventBus.on('family:add', (data) => {
      if (!data.role) return alert('請選角色');
      
      fam.rows.push(data);
      fam.render();
      
      // 通知模組清空表單
      window.CGAEventBus.emit('family:added', { success: true });
    });
    
    // 訂閱跌倒記錄新增事件
    window.CGAEventBus.on('fall:add', (data) => {
      if (!data.date && !data.place) return alert('請至少填 日期或地點');
      
      fall.list.push(data);
      fall.render();
      
      // 通知模組清空表單
      window.CGAEventBus.emit('fall:added', { success: true });
    });
    
    // 訂閱重新計算事件
    window.CGAEventBus.on('summary:recalc', () => {
      recomputeAll();
    });
    
    // 訂閱儲存事件
    window.CGAEventBus.on('summary:save', () => {
      localStorage.setItem('cga_full', JSON.stringify(snapshot()));
      alert('✅ 已儲存');
    });
    
    // 訂閱載入事件
    window.CGAEventBus.on('summary:load', () => {
      const raw = localStorage.getItem('cga_full');
      if (!raw) return alert('⚠️ 尚無資料');
      loadshot(JSON.parse(raw));
      alert('✅ 已載入');
    });
    
    // 訂閱清除事件
    window.CGAEventBus.on('summary:clear', () => {
      if (confirm('⚠️ 清除所有內容？')) {
        localStorage.removeItem('cga_full');
        localStorage.removeItem('cga_autosave');
        location.reload();
      }
    });
    
    // 訂閱匯出 JSON 事件
    window.CGAEventBus.on('summary:exportJson', () => {
      const blob = new Blob([JSON.stringify(snapshot(), null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `cga_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    });
    
    // 訂閱匯出 CSV 事件
    window.CGAEventBus.on('summary:exportCsv', () => {
      const obj = snapshot();
      const keys = Object.keys(obj);
      const row = keys.map(k => JSON.stringify(obj[k] ?? '')).join(',');
      const csv = keys.join(',') + '\n' + row + '\n';
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      a.download = `cga_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    });
    
    console.log('✅ 事件訂閱完成');
  }

  // ========================================
  // 全域事件監聽
  // ========================================
  document.addEventListener('change', recomputeAll, true);
  document.addEventListener('input', recomputeAll, true);

  // ========================================
  // 應用程式初始化
  // ========================================
  (async function init() {
    renderSteps();
    
    // 初始化家系圖和跌倒記錄管理器（使用 Form 02 提供的工廠方法）
    if (window.CGAForm02) {
      fam = window.CGAForm02.constructor.createFamilyManager();
      fall = window.CGAForm02.constructor.createFallManager();
    } else {
      // 如果模組尚未載入，使用臨時物件
      fam = { rows: [], render: () => {} };
      fall = { list: [], render: () => {} };
    }
    
    // 訂閱事件（在模組載入前）
    subscribeToEvents();
    
    // 確保 CGAModuleLoader 已載入
    if (!window.CGAModuleLoader) {
      console.error('❌ CGAModuleLoader 尚未載入！');
      alert('載入器初始化失敗，請重新整理頁面');
      return;
    }
    
    console.log('🚀 開始預先載入所有表單模組...');
    
    // 預先載入所有 15 個表單模組
    const totalModules = pages.length;
    for (let i = 0; i < totalModules; i++) {
      try {
        console.log(`📦 載入模組 ${i + 1}/${totalModules}...`);
        await window.CGAModuleLoader.loadModule(i);
        console.log(`✅ 模組 ${i + 1} 載入完成`);
      } catch (error) {
        console.error(`❌ 載入模組 ${i + 1} 失敗:`, error);
        // 繼續載入其他模組，不中斷
      }
    }
    
    console.log('✅ 所有表單模組載入完成！');
    
    // 顯示第一個頁面
    pages.forEach((p, idx) => p.classList.toggle('show', idx === 0));
    step = 0;
    renderSteps();
    
    // 綁定所有事件
    bindAllEvents();
    recomputeAll();
    
    // 自動恢復暫存資料
    const autoSaved = localStorage.getItem('cga_autosave');
    if (autoSaved) {
      try {
        loadshot(JSON.parse(autoSaved));
        console.log('✅ 已自動恢復暫存資料');
      } catch (e) {
        console.error('❌ 恢復暫存資料失敗:', e);
      }
    }
    
    // 建立自動暫存提示元素（右下角）
    const autoSaveToast = document.createElement('div');
    autoSaveToast.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 0.75rem 1rem;
      background: var(--brand);
      color: white;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 9999;
    `;
    autoSaveToast.textContent = '💾 已自動暫存';
    document.body.appendChild(autoSaveToast);
    
    // 自動暫存功能（防抖 2 秒）
    let autoSaveTimer = null;
    let toastTimer = null;
    function autoSave() {
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        try {
          localStorage.setItem('cga_autosave', JSON.stringify(snapshot()));
          
          // 顯示提示（1.5 秒後自動消失）
          autoSaveToast.style.opacity = '1';
          clearTimeout(toastTimer);
          toastTimer = setTimeout(() => {
            autoSaveToast.style.opacity = '0';
          }, 1500);
        } catch (e) {
          console.error('❌ 自動暫存失敗:', e);
        }
      }, 2000);
    }
    
    // 監聽所有表單變更
    document.addEventListener('input', autoSave, true);
    document.addEventListener('change', autoSave, true);
    
    console.log('✅ 初始化完成（已啟用自動暫存）');
  })();

  // ========================================
  // 主題切換功能
  // ========================================
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  const htmlElement = document.documentElement;
  
  // 同步主題圖示（主題已在 <head> 中套用）
  const currentTheme = htmlElement.getAttribute('data-theme');
  if (themeIcon) {
    themeIcon.textContent = currentTheme === 'dark' ? '☀️' : '🌙';
  }
  
  // 主題切換事件
  if (themeToggle) {
    themeToggle.addEventListener('click', () => {
      const currentTheme = htmlElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      // 更新自訂屬性
      htmlElement.setAttribute('data-theme', newTheme);
      
      // 更新 Flowbite 需要的 dark class
      if (newTheme === 'dark') {
        htmlElement.classList.add('dark');
      } else {
        htmlElement.classList.remove('dark');
      }
      
      themeIcon.textContent = newTheme === 'dark' ? '☀️' : '🌙';
      // 使用與 index.html 相同的 key，實現跨頁面主題記憶
      localStorage.setItem('theme', newTheme);
    });
  }
})();
</script>

</body>
</html>
