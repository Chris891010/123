<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CGA â€“ å…¨é‡è¡¨ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
<script>
  (function() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
    }
  })();
</script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  /* CSS è®Šæ•¸å®šç¾© */
  :root {
    /* äº®è‰²ä¸»é¡Œè®Šæ•¸ */
    --bg: #f6f8fb;
    --ink: #0f172a;
    --muted: #6b7280;
    --line: #e5e7eb;
    --card-bg: #ffffff;
    --card: #ffffff;
    --brand: #1d4ed8;
    --blue: #1d4ed8;
    --brand-50: #eef2ff;
    --soft: #f8fafc;
    
    /* æŒ‰éˆ•å’Œé€£çµé¡è‰² */
    --btn-text: #374151;
    --btn-bg: #ffffff;
    --btn-border: #e5e7eb;
    --link-color: #1d4ed8;
    --link-hover: #1e40af;
    
    /* è¡¨æ ¼å’Œè¡¨å–®é¡è‰² */
    --th-bg: #f3f4f6;
    --th-text: #374151;
    --input-bg: #ffffff;
    --input-text: #111827;
    --input-border: #e5e7eb;
    
    /* æ“´å±•é€šç”¨è®Šæ•¸ */
    --surface: #f8fafc;
    --surface-secondary: #e2e8f0;
    --content: #64748b;
    --shadow: rgba(15, 23, 42, 0.08);
    --shadow-lg: rgba(15, 23, 42, 0.15);
    
    /* é€šç”¨ç‹€æ…‹é¡è‰²ç³»çµ± */
    --success: #16a34a;
    --success-bg: #dcfce7;
    --success-text: #166534;
    --success-light: #f0fdf4;
    
    --warning: #f59e0b;
    --warning-bg: #fef3c7;
    --warning-text: #92400e;
    --warning-light: #fffbeb;
    
    --danger: #dc2626;
    --danger-bg: #fee2e2;
    --danger-text: #991b1b;
    --danger-light: #fef2f2;
    
    --info: #2563eb;
    --info-bg: #dbeafe;
    --info-text: #1e40af;
    --info-light: #eff6ff;
  }

  /* æš—è‰²ä¸»é¡Œ */
  [data-theme="dark"] {
    --bg: #0f172a;
    --ink: #f1f5f9;
    --muted: #94a3b8;
    --line: #334155;
    --card-bg: #1e293b;
    --card: #1e293b;
    --brand: #3b82f6;
    --blue: #3b82f6;
    --brand-50: #1e293b;
    --soft: #1e293b;
    
    --btn-text: #f1f5f9;
    --btn-bg: #334155;
    --btn-border: #475569;
    --link-color: #60a5fa;
    --link-hover: #93c5fd;
    
    --th-bg: #334155;
    --th-text: #f1f5f9;
    --input-bg: #1e293b;
    --input-text: #f1f5f9;
    --input-border: #475569;
    
    --surface: #1e293b;
    --surface-secondary: #334155;
    --content: #94a3b8;
    --shadow: rgba(0, 0, 0, 0.25);
    --shadow-lg: rgba(0, 0, 0, 0.4);
    
    /* æš—ä¸»é¡Œç‹€æ…‹é¡è‰² */
    --success: #16a34a;
    --success-bg: #052e16;
    --success-text: #4ade80;
    --success-light: #064e3b;
    
    --warning: #f59e0b;
    --warning-bg: #451a03;
    --warning-text: #fbbf24;
    --warning-light: #78350f;
    
    --danger: #dc2626;
    --danger-bg: #450a0a;
    --danger-text: #f87171;
    --danger-light: #7f1d1d;
    
    --info: #2563eb;
    --info-bg: #0c1e3e;
    --info-text: #60a5fa;
    --info-light: #1e3a8a;
  }

  /* åŸºç¤é‡ç½® */
/* #region åŸºç¤æ¨£å¼ */
  * {
    box-sizing: border-box;
  }

  /* ä¸»é¡Œåˆ‡æ›å¹³æ»‘éæ¸¡ */
  :root {
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  body {
    margin: 0;
    background: var(--bg);
    font-family: "Noto Sans TC", system-ui, sans-serif;
    color: var(--ink);
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  /* ç‚ºæ‰€æœ‰ä½¿ç”¨CSSè®Šæ•¸çš„å…ƒç´ æ·»åŠ éæ¸¡æ•ˆæœ */
  *:not(script):not(style) {
    transition-property: background-color, border-color, color, fill, stroke;
    transition-duration: 0.3s;
    transition-timing-function: ease;
  }

  /* å®¹å™¨èˆ‡ç¶²æ ¼ */
  .container {
    max-width: 1440px;
    margin: 0 auto;
    padding: 14px;
  }

  h1 {
    margin: 0.2rem 0 0.8rem;
  }

  .grid {
    display: grid;
    gap: 12px;
  }

  @media (min-width: 980px) {
    .grid.cols-2 {
      grid-template-columns: 3fr 1fr;
    }
  }

  /* é¢æ¿ */
  .panel {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 14px;
  }

  /* æ­¥é©Ÿæ¢ */
  #stepbar {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin: 0.2rem 0 0.8rem;
  }

  .step {
    padding: 0.32rem 0.6rem;
    border: 1px solid var(--line);
    border-radius: 999px;
    background: var(--card-bg);
    color: var(--ink);
    cursor: pointer;
    font-size: 0.85rem;
  }

  .step.active {
    background: var(--brand-50);
    border-color: var(--brand);
    color: var(--brand);
  }

  /* æ§åˆ¶æŒ‰éˆ• */
  .controls {
    display: flex;
    gap: 0.6rem;
    align-items: center;
    flex-wrap: wrap;
    margin: 0.8rem 0;
  }

  /* æŒ‰éˆ•è®Šé«”æ¨£å¼ï¼ˆçµ±ä¸€åœ¨å¾Œé¢å®šç¾©ï¼‰ */
  .btn.primary {
    background: var(--brand);
    border-color: var(--brand);
    color: #fff;
  }

  .btn.warn {
    background: var(--warning-light);
    border-color: var(--warning);
    color: var(--warning-text);
  }

  .hint {
    color: var(--muted);
    font-size: 0.85rem;
  }

  /* é é¢åˆ‡æ› */
  .page {
    display: none;
  }

  .page.show {
    display: block;
  }

  /* è¡¨å–®å¸ƒå±€ */
  .form {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 0.8rem;
  }

  .field {
    grid-column: span 3;
  }

  .col-2 {
    grid-column: span 2;
  }

  .col-4 {
    grid-column: span 4;
  }

  .col-6 {
    grid-column: span 6;
  }

  .col-8 {
    grid-column: span 8;
  }

  .col-12 {
    grid-column: span 12;
  }

  /* è¡¨å–®å…ƒç´  */
  label {
    display: block;
    color: var(--muted);
    font-size: 0.86rem;
    margin-bottom: 0.25rem;
  }

  input,
  select,
  textarea {
    width: 100%;
    border: 1px solid var(--input-border);
    border-radius: 10px;
    padding: 0.56rem 0.65rem;
    background: var(--input-bg);
    color: var(--input-text);
  }

  /* å€å¡Š */
  .sec {
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 12px;
    margin: 0.8rem 0;
    background: var(--card-bg);
  }

  .sec h3 {
    margin: 0.1rem 0 0.5rem;
  }

  /* æ¨™ç±¤ */
  .badge {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    border: 1px solid var(--brand);
    background: var(--brand-50);
    color: var(--brand);
    padding: 0.12rem 0.55rem;
    font-size: 0.78rem;
    font-weight: 700;
  }

  .tag {
    display: inline-flex;
    align-items: center;
    border: 1px solid var(--line);
    border-radius: 999px;
    background: var(--surface);
    color: var(--ink);
    padding: 0.18rem 0.5rem;
    margin: 0.2rem 0.25rem;
    font-size: 0.85rem;
  }

  /* è¡¨æ ¼ */
  .table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .table th,
  .table td {
    border-bottom: 1px solid var(--line);
    padding: 0.5rem 0.5rem;
    vertical-align: top;
  }

  .table thead th {
    background: var(--th-bg);
    color: var(--th-text);
  }

  /* CCI chips - æ”¹è‰¯é¿å…é‡ç–Š */
  .cci-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .cci {
    min-width: 138px;
    max-width: 180px;
    padding: 0.45rem 0.6rem;
    border: 1px solid var(--line);
    border-radius: 20px;
    background: var(--card-bg);
    color: var(--ink);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  /* è¼”åŠ©å·¥å…· */
  .helper h2 {
    margin: 0.2rem 0 0.5rem;
  }

  .helper .card {
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 0.75rem;
    margin: 0.6rem 0;
  }

  .tool a {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    text-decoration: none;
    color: var(--ink);
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 0.5rem 0.6rem;
    background: var(--surface);
  }

  .tool a:hover {
    background: var(--brand-50);
    border-color: var(--brand);
  }

  .pop {
    font-size: 0.85rem;
    color: #1e3a8a;
  }

  /* =========================== */
  /* æŒ‰éˆ•ç³»çµ± */
  /* =========================== */
  
  /* åŸºç¤æŒ‰éˆ•æ¨£å¼ */
  .btn {
    border: 1px solid var(--btn-border);
    background: var(--btn-bg);
    color: var(--btn-text);
    border-radius: 10px;
    padding: 0.5rem 0.8rem;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.2s ease;
    user-select: none;
    -webkit-user-select: none;
  }

  /* Hover ç‹€æ…‹ */
  .btn:hover {
    background: var(--surface-secondary);
    border-color: var(--brand);
    opacity: 0.9;
  }

  /* Active/é¸ä¸­ ç‹€æ…‹ */
  .btn.active {
    background: var(--brand);
    border-color: var(--brand);
    color: #ffffff;
  }

  .btn.active:hover {
    opacity: 0.9;
  }

  /* Primary è®Šé«” */
  .btn.primary {
    background: var(--brand);
    border-color: var(--brand);
    color: #ffffff;
  }

  .btn.primary:hover {
    opacity: 0.9;
  }

  /* Warning è®Šé«” */
  .btn.warn {
    background: var(--warning-light);
    border-color: var(--warning);
    color: var(--warning-text);
  }

  .btn.warn:hover {
    opacity: 0.9;
  }

  /* Success è®Šé«” */
  .btn.success {
    background: var(--success-light);
    border-color: var(--success);
    color: var(--success-text);
  }

  .btn.success:hover {
    opacity: 0.9;
  }

  /* Danger è®Šé«” */
  .btn.danger {
    background: var(--danger-light);
    border-color: var(--danger);
    color: var(--danger-text);
  }

  .btn.danger:hover {
    opacity: 0.9;
  }

  /* Header æ¨£å¼ */
  header {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  header h1 {
    flex: 1;
    min-width: 200px;
  }

  @media (max-width: 768px) {
    header {
      gap: 8px;
    }
    
    .btn {
      padding: 0.4rem 0.6rem;
      font-size: 0.9rem;
    }
  }
</style>
</head>
<body>
<header class="container">
  <h1>ç¶œåˆè€å¹´è©•ä¼°ï¼ˆCGAï¼‰â€” ä¿®æ­£ç‰ˆ</h1>
  <button class="btn" type="button" id="themeToggle" title="åˆ‡æ›ä¸»é¡Œ">
    <span id="themeIcon">ğŸŒ™</span>
  </button>
</header>

<main class="container grid cols-2">
  <!-- LEFT -->
  <section class="panel">
    <div id="stepbar"></div>

    <!-- 1 åŸºæœ¬è³‡æ–™ -->
    <div class="page" data-title="åŸºæœ¬è³‡æ–™">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 2 å€‹äººå² / å®¶ç³»åœ– / é‡å¤§ç–¾ç—… / åŠŸèƒ½å›é¡§ / è·Œå€’è¨˜äº‹ -->
    <div class="page" data-title="å€‹äººå²/å®¶ç³»åœ–/åŠŸèƒ½å›é¡§">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 3 ADL -->
    <div class="page" data-title="ADLï¼ˆBarthelï¼‰">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 4 IADL -->
    <div class="page" data-title="IADLï¼ˆLawtonï¼‰">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 5 Mini-Cog + CDT + MMSE -->
    <div class="page" data-title="Mini-Cog / MMSE">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 6 MoCA -->
    <div class="page" data-title="MoCA">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 7 GDS-5 / CAM / Braden -->
    <div class="page" data-title="GDS-5 / CAM / Braden">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 8 ç‡Ÿé¤Š -->
    <div class="page" data-title="ç‡Ÿé¤Šï¼ˆMNA-SFï¼‰">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 9 è¡Œå‹•/è‚Œå°‘ -->
    <div class="page" data-title="è¡Œå‹•/è‚Œå°‘ï¼ˆCHSï¼‰">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 10 è·Œå€’è©•ä¼° -->
    <div class="page" data-title="è·Œå€’è©•ä¼°ï¼ˆSTRATIFY / Morseï¼‰">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 11 B9 EQ-5D-3L / VAS -->
    <div class="page" data-title="B9 ç”Ÿæ´»å“è³ªï¼ˆEQ-5D-3L / VASï¼‰">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 12 B11 åš´é‡åº¦æŒ‡æ•¸ -->
    <div class="page" data-title="B11 åš´é‡åº¦æŒ‡æ•¸">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 13 CCI -->
    <div class="page" data-title="CCI å…±ç—…æŒ‡æ•¸">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 14 å‡ºé™¢ç‹€æ³ -->
    <div class="page" data-title="å‡ºé™¢ç‹€æ³">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 15 æ‘˜è¦/è¼¸å‡º -->
    <div class="page" data-title="æ‘˜è¦ / åŒ¯å‡º">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <div class="controls" style="justify-content:space-between">
      <button class="btn" id="prev">â† ä¸Šä¸€æ­¥</button>
      <div class="hint" id="stepLabel"></div>
      <button class="btn primary" id="next">ä¸‹ä¸€æ­¥ â†’</button>
    </div>
  </section>

  <!-- RIGHTï¼šå·¥å…· -->
  <aside class="panel helper">
    <h2>å·¥å…· & é€£çµ</h2>
    <div class="card" id="tipBox"><div class="pop">ä¾æ­¥é©Ÿé¡¯ç¤ºè¦é»ã€‚</div></div>
    <div class="card">
      <h3>é‡è¡¨ç¶²ç«™</h3>
      <div class="tool"><a href="https://www.mocatest.org/" target="_blank" rel="noopener">MoCA<span>å®˜æ–¹</span></a></div>
      <div class="tool"><a href="https://www.parinc.com/Products/Pkey/238" target="_blank" rel="noopener">MMSE<span>PAR</span></a></div>
      <div class="tool"><a href="https://mini-cog.com" target="_blank" rel="noopener">Mini-Cog<span>æŒ‡å—</span></a></div>
      <div class="tool"><a href="https://www.icudelirium.org/medical-professionals/delirium/monitoring-delirium/cam-icudelirium" target="_blank" rel="noopener">CAM<span>è­«å¦„</span></a></div>
      <div class="tool"><a href="https://www.stanford.edu/~yesavage/GDS.html" target="_blank" rel="noopener">GDS<span>è€å¹´æ†‚é¬±</span></a></div>
      <div class="tool"><a href="https://www.mna-elderly.com" target="_blank" rel="noopener">MNA-SF<span>ç‡Ÿé¤Š</span></a></div>
      <div class="tool"><a href="https://www.cdc.gov/steadi/pdf/TUG_Test-print.pdf" target="_blank" rel="noopener">TUG<span>æ­¥æ…‹</span></a></div>
      <div class="tool"><a href="https://www.mdcalc.com/calc/3916/braden-scale-pressure-ulcer-risk" target="_blank" rel="noopener">Braden<span>å£“å‚·</span></a></div>
    </div>
  </aside>
</main>

<!-- CGA è¡¨å–®æ¨¡çµ„è¼‰å…¥å™¨ï¼ˆå¿…é ˆåœ¨ä¸»è…³æœ¬ä¹‹å‰è¼‰å…¥ï¼‰ -->
<script src="cga-module-loader.js"></script>

<script>
(() => {
  const pages=[...document.querySelectorAll('.page')];
  let step=0;
  const stepbar=document.getElementById('stepbar');
  function renderSteps(){
    stepbar.innerHTML='';
    pages.forEach((p,i)=>{
      const b=document.createElement('button'); b.className='step'+(i===step?' active':''); b.textContent=(i+1)+'. '+p.dataset.title;
      b.onclick=()=>show(i); stepbar.appendChild(b);
    });
    document.getElementById('stepLabel').textContent=`ç¬¬ ${step+1}/${pages.length} æ­¥ï¼š${pages[step].dataset.title}`;
  }
  async function show(i){
    if(i<0||i>=pages.length) return;
    
    console.log(`ğŸ“ show(${i}) é–‹å§‹åŸ·è¡Œ`);
    console.log(`ğŸ“ CGAModuleLoader å­˜åœ¨:`, !!window.CGAModuleLoader);
    
    // å…ˆè¼‰å…¥è¡¨å–®æ¨¡çµ„ï¼ˆå¦‚æœå°šæœªè¼‰å…¥ï¼‰
    try {
      console.log(`ğŸ“ é–‹å§‹è¼‰å…¥æ¨¡çµ„ ${i}...`);
      await window.CGAModuleLoader.loadModule(i);
      console.log(`âœ… æ¨¡çµ„ ${i} è¼‰å…¥å®Œæˆ`);
      
      // æª¢æŸ¥å…§å®¹æ˜¯å¦å·²æ³¨å…¥
      const pageElement = pages[i];
      console.log(`ğŸ“ é é¢ ${i} å…§å®¹é•·åº¦:`, pageElement.innerHTML.length);
      
    } catch (error) {
      console.error(`âŒ è¼‰å…¥æ¨¡çµ„ ${i+1} å¤±æ•—:`, error);
      alert(`âš ï¸ è¼‰å…¥è¡¨å–®å¤±æ•—ï¼š${error.message}\n\nè«‹ç¢ºèªä½¿ç”¨ HTTP ä¼ºæœå™¨é–‹å•Ÿæ­¤é é¢`);
      return;
    }
    
    // åˆ‡æ›é¡¯ç¤º
    console.log(`ğŸ“ åˆ‡æ›åˆ°é é¢ ${i}`);
    pages.forEach((p,idx)=>p.classList.toggle('show',idx===i));
    step=i; renderSteps(); window.scrollTo({top:0,behavior:'smooth'});
    
    // æ¯æ¬¡åˆ‡æ›é é¢æ™‚ç¶å®šäº‹ä»¶å’Œé‡æ–°è¨ˆç®—
    console.log(`ğŸ“ ç¶å®šäº‹ä»¶å’Œé‡æ–°è¨ˆç®—`);
    bindAllEvents();
    recomputeAll();
    console.log(`âœ… show(${i}) å®Œæˆ`);
  }
  document.getElementById('prev').onclick=()=>show(step-1);
  document.getElementById('next').onclick=()=>show(step+1);

  // ==== Util
  const $=(s,root=document)=>root.querySelector(s);
  const $$=(s,root=document)=>Array.from(root.querySelectorAll(s));
  const nv=(el)=> (el?.value??'').trim();
  const num=(el)=>{ const v=parseFloat(nv(el)); return Number.isFinite(v)?v:null; };
  const tag=(wrap,txt)=>{ const t=document.createElement('span'); t.className='tag'; t.textContent=txt; wrap.appendChild(t); };

  // ==== BMI/IBW
  function syncAnthro(){
    const h=num($('#ht')), w=num($('#wt'));
    if(h&&w){ const m=h/100, bmi=w/(m*m), ibw=22*m*m; $('#bmi').value=bmi.toFixed(1); $('#ibw').value=ibw.toFixed(1); $('#ibwDiff').value=(w-ibw).toFixed(1); }
    else { $('#bmi').value=''; $('#ibw').value=''; $('#ibwDiff').value=''; }
    // è‡ªå‹•å¡«å…… MNA BMI é …ç›®
    if (window.CGAForm08 && typeof window.CGAForm08.autoMNA_BMI === 'function') {
      window.CGAForm08.autoMNA_BMI();
    }
  }
  function bindAnthroEvents(){
    const ht = $('#ht'), wt = $('#wt');
    if(ht && wt) {
      ['input','change'].forEach(ev=>{
        ht.addEventListener(ev,syncAnthro);
        wt.addEventListener(ev,syncAnthro);
      });
    }
  }

  // ==== Family
  const fam={rows:[]};
  function bucket(role){ if(role==='çˆ¶è¦ª'||role==='æ¯è¦ª')return'Parent'; if(role==='é…å¶')return'Spouse'; if(role==='å…„å¼Ÿå§Šå¦¹')return'Sibling'; if(role==='å­å¥³')return'Child'; return'Other'; }
  function renderFam(){
    const map={Parent:'#rowParent',Spouse:'#rowSpouse',Sibling:'#rowSibling',Child:'#rowChild',Other:'#rowOther'};
    // æª¢æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼ˆè¡¨å–®å¯èƒ½å°šæœªè¼‰å…¥ï¼‰
    const firstElement = $(Object.values(map)[0]);
    if (!firstElement) return; // è¡¨å–®æœªè¼‰å…¥æ™‚è·³é
    
    Object.values(map).forEach(s=>{
      const el = $(s);
      if (el) el.innerHTML = '';
    });
    fam.rows.forEach((m,i)=>{
      const pill=document.createElement('span'); pill.className='tag'; pill.innerHTML=`${m.name||'ï¼ˆæœªåï¼‰'}ãƒ»${m.sex||'?'}ãƒ»${m.age||'?'}ãƒ»${m.status||''} <small>${m.role}</small> <span style="color:#b91c1c;cursor:pointer" data-i="${i}">Ã—</span>`;
      const target = $(map[bucket(m.role)]);
      if (target) target.appendChild(pill);
    });
    $$('#famRows span[data-i]').forEach(x=>x.onclick=()=>{ fam.rows.splice(+x.dataset.i,1); renderFam(); });
  }
  // addFam äº‹ä»¶ç¶å®šç§»è‡³ bindAllEvents()

  // ==== Fall log
  const fall={list:[]};
  function renderFall(){ 
    const box=$('#fallList'); 
    if (!box) return; // è¡¨å–®æœªè¼‰å…¥æ™‚è·³é
    box.innerHTML=''; 
    fall.list.forEach((e,i)=>{ 
      const pill=document.createElement('span'); 
      pill.className='tag'; 
      pill.innerHTML=`${e.date||''}ãƒ»${e.place||''}ãƒ»${e.context||''}ãƒ»${e.outcome||''} <small>${e.note||''}</small> <span style="color:#b91c1c;cursor:pointer" data-i="${i}">Ã—</span>`; 
      box.appendChild(pill); 
    }); 
    $$('#fallList span[data-i]').forEach(x=>x.onclick=()=>{ fam.rows.splice(+x.dataset.i,1); renderFall(); }); 
  }
  // addFall äº‹ä»¶ç¶å®šç§»è‡³ bindAllEvents()

  // ==== ADL - å·²ç§»è‡³ modules/forms/03-form.js
  // ä½¿ç”¨ window.CGAForm03.initialize() å’Œ window.CGAForm03.compute()

  // ==== IADL
  // ==== IADL - å·²ç§»è‡³ modules/forms/04-form.js
  // ä½¿ç”¨ window.CGAForm04.initialize() å’Œ window.CGAForm04.compute()

  // ==== Mini-Cog + MMSE - å·²ç§»è‡³ modules/forms/05-form.js
  // ä½¿ç”¨ window.CGAForm05.compute()

  // ==== MoCA - å·²ç§»è‡³ modules/forms/06-form.js
  // ä½¿ç”¨ window.CGAForm06.compute()


  // ==== GDS-5 / CAM - å·²ç§»è‡³ modules/forms/07-form.js
  // ä½¿ç”¨ window.CGAForm07.initialize() å’Œ window.CGAForm07.compute()

  // ==== CAM - å·²ç§»è‡³ modules/forms/07-form.js

  // ==== Braden - å·²ç§»è‡³ modules/forms/07-form.js

  // ==== MNA-SF - å·²ç§»è‡³ modules/forms/08-form.js
  // ä½¿ç”¨ window.CGAForm08.initialize() å’Œ window.CGAForm08.compute()

  // ==== è¡Œå‹• / CHS - å·²ç§»è‡³ modules/forms/09-form.js
  // ä½¿ç”¨ window.CGAForm09.compute()


  // ==== STRATIFY / Morse - å·²ç§»è‡³ modules/forms/10-form.js
  // ä½¿ç”¨ window.CGAForm10.initialize() å’Œ window.CGAForm10.compute()

  // ==== EQ5D - å·²ç§»è‡³ modules/forms/11-form.js
  // ä½¿ç”¨ window.CGAForm11.initialize()

  // ==== B11 - å·²ç§»è‡³ modules/forms/12-form.js
  // ä½¿ç”¨ window.CGAForm12.compute()

  // ==== CCI - å·²ç§»è‡³ modules/forms/13-form.js
  // ä½¿ç”¨ window.CGAForm13.initialize() å’Œ window.CGAForm13.compute()


  // ==== æ‘˜è¦ / æ¨™ç±¤
  function recomputeAll(){
    syncAnthro(); 
    
    // ä½¿ç”¨æ¨¡çµ„çš„ compute æ–¹æ³•ï¼ˆå·²é‡æ§‹çš„æ¨¡çµ„ï¼‰
    if (window.CGAForm03 && typeof window.CGAForm03.compute === 'function') {
      window.CGAForm03.compute();
    }
    if (window.CGAForm04 && typeof window.CGAForm04.compute === 'function') {
      window.CGAForm04.compute();
    }
    if (window.CGAForm05 && typeof window.CGAForm05.compute === 'function') {
      window.CGAForm05.compute();
    }
    if (window.CGAForm06 && typeof window.CGAForm06.compute === 'function') {
      window.CGAForm06.compute();
    }
    if (window.CGAForm07 && typeof window.CGAForm07.compute === 'function') {
      window.CGAForm07.compute();
    }
    if (window.CGAForm08 && typeof window.CGAForm08.compute === 'function') {
      window.CGAForm08.compute();
    }
    if (window.CGAForm09 && typeof window.CGAForm09.compute === 'function') {
      window.CGAForm09.compute();
    }
    if (window.CGAForm10 && typeof window.CGAForm10.compute === 'function') {
      window.CGAForm10.compute();
    }
    if (window.CGAForm12 && typeof window.CGAForm12.compute === 'function') {
      window.CGAForm12.compute();
    }
    if (window.CGAForm13 && typeof window.CGAForm13.compute === 'function') {
      window.CGAForm13.compute();
    }
    
    // æ¨™ç±¤
    const box=$('#riskTags'); 
    if (!box) return; // æ‘˜è¦é æœªè¼‰å…¥æ™‚è·³é
    box.innerHTML='';
    const gds=+$('#gdsTotal').textContent||0; if(gds>=2) tag(box,'GDS-5 â‰¥2');
    const cam=nv($('#camResult')); if(cam==='è­«å¦„') tag(box,'CAM è­«å¦„');
    const br=+$('#bradenTotal').textContent||0; if(br && br<=12) tag(box,'Braden é«˜é¢¨éšª');
    const mna=+$('#mnaTotal').textContent||0; if(mna<=7) tag(box,'MNA-SF ç‡Ÿé¤Šä¸è‰¯'); else if(mna<=11) tag(box,'MNA-SF é¢¨éšª');
    const chs=+$('#chsTotal').textContent||0; if(chs>=3) tag(box,'CHS è¡°å¼±'); else if(chs>=1) tag(box,'CHS å‰è¡°å¼±');
    const morse=+$('#morseTotal').textContent||0; if(morse>=46) tag(box,'Morse â‰¥46 é«˜è·Œå€’é¢¨éšª');
    const mmse=+$('#mmseTotal').textContent||0; if(mmse && mmse<=23) tag(box,'MMSE â‰¤23');
    const moca=+$('#mocaTotal').textContent||0; if(moca && moca<26) tag(box,'MoCA <26');
    const adl=+$('#adlTotal').textContent||0; if(adl<=60) tag(box,'ADL â‰¤60');
    const cci=+$('#cciTotal').textContent||0; if(cci>=5) tag(box,'CCI â‰¥5');
    // æ‘˜è¦
    const nm=nv($('#pname'))||'å€‹æ¡ˆ', age=nv($('#age'))||'?', sex=nv($('#sex'))||'';
    const sum=`${nm}ï¼ˆ${age}æ­²${sex}ï¼‰ã€‚ADL ${adl}/100ï¼›IADL ${$('#iadlTotal').textContent}/${$('#iadlMax').textContent}ï¼›Mini-Cog ${$('#miniTotal').value||'NA'}/5ï¼ˆ${nv($('#miniBinary'))||'NA'}ï¼‰ï¼›MMSE ${mmse||'NA'}/30ï¼›MoCA ${moca||'NA'}/30ï¼›GDS-5 ${gds}/5ï¼›MNA-SF ${mna}/14ï¼›æ­¥é€Ÿ ${nv($('#gaitSpeed'))||'NA'} m/sï¼›TUG ${nv($('#tug'))||'NA'} sï¼›æ¡åŠ›æœ€å¤§ ${nv($('#gripMax'))||'NA'} kgï¼›CFS ${nv($('#cfs'))||'NA'}ï¼›STRATIFY ${$('#stratifyTotal').textContent}ï¼›Morse ${morse}ï¼›EQ-VAS ${nv($('#eqVASVal'))||'NA'}ï¼›CCI ${cci}ï¼›å‡ºé™¢ï¼š${nv($('#dcDest'))||'NA'}ã€‚`;
    $('#summary').value=sum;
  }

  // ==== Storage / Export
  function snapshot(){
    const data={};
    $$('input,select,textarea').forEach(el=>{
      const key=el.id||el.name||el.getAttribute('data-k'); if(!key) return;
      if(el.type==='radio'){ if(el.checked) data[key]=el.value; }
      else if(el.type==='checkbox'){ data[key]=el.checked; }
      else data[key]=el.value;
    });
    data['fam']=JSON.stringify(fam.rows); data['falls']=JSON.stringify(fall.list);
    return data;
  }
  function loadshot(obj){
    $$('input,select,textarea').forEach(el=>{
      const key=el.id||el.name||el.getAttribute('data-k'); if(!(key in obj)) return;
      if(el.type==='checkbox') el.checked=!!obj[key];
      else if(el.type==='radio') { if(el.value==obj[key]) el.checked=true; }
      else el.value=obj[key];
    });
    try{ fam.rows=JSON.parse(obj.fam||'[]'); }catch{}
    try{ fall.list=JSON.parse(obj.falls||'[]'); }catch{}
    renderFam(); renderFall(); recomputeAll();
  }
  
  // ==== çµ±ä¸€äº‹ä»¶ç¶å®šå‡½æ•¸
  let eventsBindingInitialized = false;
  
  function bindAllEvents() {
    // åˆå§‹åŒ–æ‰€æœ‰å‹•æ…‹è¡¨å–®ï¼ˆèª¿ç”¨æ¨¡çµ„çš„ initialize æ–¹æ³•ï¼‰
    // åªåˆå§‹åŒ–å·²è¼‰å…¥çš„æ¨¡çµ„
    if (window.CGAForm03 && typeof window.CGAForm03.initialize === 'function') {
      window.CGAForm03.initialize();
    }
    if (window.CGAForm04 && typeof window.CGAForm04.initialize === 'function') {
      window.CGAForm04.initialize();
    }
    if (window.CGAForm07 && typeof window.CGAForm07.initialize === 'function') {
      window.CGAForm07.initialize();
    }
    if (window.CGAForm08 && typeof window.CGAForm08.initialize === 'function') {
      window.CGAForm08.initialize();
    }
    if (window.CGAForm10 && typeof window.CGAForm10.initialize === 'function') {
      window.CGAForm10.initialize();
    }
    if (window.CGAForm11 && typeof window.CGAForm11.initialize === 'function') {
      window.CGAForm11.initialize();
    }
    if (window.CGAForm13 && typeof window.CGAForm13.initialize === 'function') {
      window.CGAForm13.initialize();
    }
    
    // åŸºæœ¬è³‡æ–™é çš„äº‹ä»¶
    bindAnthroEvents();
    
    // å®¶ç³»åœ–å’Œè·Œå€’äº‹ä»¶
    const addFam = $('#addFam');
    if (addFam) {
      addFam.onclick = () => {
        const m={role:nv($('#famRole')),name:nv($('#famName')),sex:nv($('#famSex')),age:nv($('#famAge')),status:nv($('#famStatus')),dx:nv($('#famDx'))};
        if(!m.role) return alert('è«‹é¸è§’è‰²'); fam.rows.push(m);
        ['famRole','famName','famSex','famAge','famStatus','famDx'].forEach(id=>$('#'+id).value=''); renderFam();
      };
    }
    
    const addFall = $('#addFall');
    if (addFall) {
      addFall.onclick = () => { 
        const e={date:nv($('#feDate')),place:nv($('#fePlace')),context:nv($('#feCtx')),outcome:nv($('#feOut')),note:nv($('#feNote'))}; 
        if(!e.date && !e.place) return alert('è«‹è‡³å°‘å¡« æ—¥æœŸæˆ–åœ°é»'); 
        fall.list.push(e); 
        ['feDate','fePlace','feCtx','feOut','feNote'].forEach(id=>$('#'+id).value=''); 
        renderFall(); 
      };
    }
    
    // æ‘˜è¦é çš„äº‹ä»¶ï¼ˆé€™äº›æŒ‰éˆ•åªç¶å®šä¸€æ¬¡ï¼‰
    if (!eventsBindingInitialized) {
      const recalc = $('#recalc');
      if (recalc) recalc.onclick = recomputeAll;
      
      const save = $('#save');
      if (save) save.onclick = () => { localStorage.setItem('cga_full', JSON.stringify(snapshot())); alert('å·²å„²å­˜'); };
      
      const load = $('#load');
      if (load) load.onclick = () => { const raw=localStorage.getItem('cga_full'); if(!raw) return alert('å°šç„¡è³‡æ–™'); loadshot(JSON.parse(raw)); };
      
      const clear = $('#clear');
      if (clear) clear.onclick = () => { if(confirm('æ¸…é™¤æ‰€æœ‰å…§å®¹ï¼Ÿ')){ localStorage.removeItem('cga_full'); location.reload(); } };
      
      const exportJson = $('#exportJson');
      if (exportJson) exportJson.onclick = () => { const blob=new Blob([JSON.stringify(snapshot(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='cga.json'; a.click(); };
      
      const exportCsv = $('#exportCsv');
      if (exportCsv) exportCsv.onclick = () => { const obj=snapshot(); const keys=Object.keys(obj); const row=keys.map(k=>JSON.stringify(obj[k]??'')).join(','); const csv=keys.join(',')+'\n'+row+'\n'; const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='cga.csv'; a.click(); };
      
      // IADL ç”·æ€§è·³éé¸é …
      const iadlMaleSkip = $('#iadlMaleSkip');
      if (iadlMaleSkip) iadlMaleSkip.onchange = () => {
        if (window.CGAForm04 && typeof window.CGAForm04.compute === 'function') {
          window.CGAForm04.compute();
        }
      };
      
      eventsBindingInitialized = true;
    }
  }

  // ==== Wiringï¼ˆå…¨åŸŸäº‹ä»¶ï¼‰
  document.addEventListener('change',recomputeAll,true);
  document.addEventListener('input',recomputeAll,true);

  // åˆå§‹åŒ–ï¼ˆç•°æ­¥è¼‰å…¥ç¬¬ä¸€å€‹è¡¨å–®ï¼‰
  (async function init() {
    renderSteps(); renderFam(); renderFall();
    
    // ç¢ºä¿ CGAModuleLoader å·²è¼‰å…¥
    if (!window.CGAModuleLoader) {
      console.error('âŒ CGAModuleLoader å°šæœªè¼‰å…¥ï¼');
      alert('è¼‰å…¥å™¨åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
      return;
    }
    
    console.log('âœ… é–‹å§‹è¼‰å…¥ç¬¬ä¸€å€‹è¡¨å–®...');
    await show(0); // è¼‰å…¥ç¬¬ä¸€å€‹è¡¨å–®ä¸¦é¡¯ç¤º
    console.log('âœ… ç¬¬ä¸€å€‹è¡¨å–®è¼‰å…¥å®Œæˆ');
  })();

  // ==== ä¸»é¡Œåˆ‡æ›åŠŸèƒ½ï¼ˆèˆ‡ index.html å…±äº«è¨­å®šï¼‰
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  const htmlElement = document.documentElement;
  
  // åŒæ­¥ä¸»é¡Œåœ–ç¤ºï¼ˆä¸»é¡Œå·²åœ¨ <head> ä¸­å¥—ç”¨ï¼‰
  const currentTheme = htmlElement.getAttribute('data-theme');
  if (themeIcon) {
    themeIcon.textContent = currentTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
  }
  
  // ä¸»é¡Œåˆ‡æ›äº‹ä»¶
  if (themeToggle) {
    themeToggle.addEventListener('click', () => {
      const currentTheme = htmlElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      htmlElement.setAttribute('data-theme', newTheme);
      themeIcon.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
      // ä½¿ç”¨èˆ‡ index.html ç›¸åŒçš„ keyï¼Œå¯¦ç¾è·¨é é¢ä¸»é¡Œè¨˜æ†¶
      localStorage.setItem('theme', newTheme);
    });
  }
})();
</script>

</body>
</html>
