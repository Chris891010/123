<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CGA â€“ å…¨é‡è¡¨ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
<script>
  (function() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      document.documentElement.classList.add('dark');
    }
  })();
</script>

<!-- å­—é«”ï¼ˆæœ¬åœ°å„ªå…ˆï¼ŒCDN å‚™æ´ï¼‰ -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">

<!-- å…±ç”¨æ¨£å¼æ¨¡çµ„ï¼ˆåŸºç¤å„ªå…ˆï¼‰ -->
<link href="../styles/theme-variables.css" rel="stylesheet">
<link href="../styles/base.css?v=2024100501" rel="stylesheet">
<link href="../styles/buttons.css" rel="stylesheet">
    <link href="../styles/forms.css?v=2024100507" rel="stylesheet"><!-- Flowbite (æœ¬åœ°åŒ–å®Œæ•´ç‰ˆ) -->
<link href="../styles/flowbite.min.css" rel="stylesheet">
<link href="../styles/datepicker-theme.css" rel="stylesheet">

<style>
/* #region CGA2.html å°ˆå±¬æ¨£å¼ */

/* éŸ¿æ‡‰å¼ç¶²æ ¼ */
.grid {
  display: grid;
  gap: 20px;
}

  @media (min-width: 980px) {
    .grid.cols-2 {
      grid-template-columns: 1fr 380px;
    }
  }

  @media (max-width: 979px) {
    .container {
      padding: 16px;
    }
    
    h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
  }

  /* ========================================
     é¢æ¿èˆ‡å¡ç‰‡
     ======================================== */
  .panel {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
  }

  [data-theme="dark"] .panel {
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
  }

  /* ========================================
     æ­¥é©Ÿå°èˆªæ¢
     ======================================== */
  #stepbar {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin: 0 0 2rem;
    padding: 1.5rem 0;
    border-bottom: 2px solid var(--line);
  }

  .step {
    padding: 10px 20px;
    border: 2px solid var(--line);
    border-radius: 999px;
    background: var(--card-bg);
    color: var(--muted);
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .step:hover {
    border-color: var(--brand);
    color: var(--brand);
    background: var(--brand-50);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(29, 78, 216, 0.2);
  }

  .step.active {
    background: linear-gradient(135deg, var(--brand) 0%, #2563eb 100%);
    border-color: var(--brand);
    color: #ffffff;
    font-weight: 700;
    box-shadow: 0 4px 16px rgba(29, 78, 216, 0.4);
    transform: scale(1.05);
  }

  .step.active:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(29, 78, 216, 0.5);
  }

  /* ========================================
     æ§åˆ¶å€åŸŸ
     ======================================== */
  .controls {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    margin: 1.5rem 0;
    padding-top: 1rem;
    border-top: 1px solid var(--line);
  }

  .hint {
    color: var(--muted);
    font-size: 0.875rem;
    line-height: 1.6;
    padding: 12px 16px;
    background: var(--info-light);
    border-radius: 8px;
    margin: 1rem 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  [data-theme="dark"] .hint {
    background: rgba(37, 99, 235, 0.15);
  }

  /* é é¢åˆ‡æ› */
  .page {
    display: none;
  }

  .page.show {
    display: block;
  }

  /* ========================================
     è¡¨å–®ä½ˆå±€ç³»çµ±
     ======================================== */
  .form {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 20px;
    margin: 1.5rem 0;
  }

  .field {
    grid-column: span 3;
    position: relative;
  }

  .col-2 {
    grid-column: span 2;
  }

  .col-4 {
    grid-column: span 4;
  }

  .col-6 {
    grid-column: span 6;
  }

  .col-8 {
    grid-column: span 8;
  }

  .col-12 {
    grid-column: span 12;
  }

  /* éŸ¿æ‡‰å¼è¡¨å–® */
  @media (max-width: 768px) {
    .form {
      gap: 12px;
    }
    
    .field,
    .col-2,
    .col-4,
    .col-6,
    .col-8 {
      grid-column: span 12;
    }
  }

  /* ========================================
     å…§å®¹å€å¡Š
     ======================================== */
  .sec {
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 24px;
    margin: 1.5rem 0;
    background: var(--card-bg);
    box-shadow: 0 2px 8px var(--shadow);
  }

  .sec h3 {
    margin: 0 0 1.25rem;
    padding-bottom: 0.875rem;
    border-bottom: 2px solid var(--line);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--ink);
    letter-spacing: 0.02em;
  }

  .sec:first-child {
    margin-top: 0;
  }

  .sec:last-child {
    margin-bottom: 0;
  }

  /* æ¨™ç±¤ */
  .badge {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    border: 2px solid var(--brand);
    background: var(--brand-50);
    color: var(--brand);
    padding: 0.25rem 0.75rem;
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.03em;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
  }

  .tag {
    display: inline-flex;
    align-items: center;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: var(--surface);
    color: var(--ink);
    padding: 0.35rem 0.75rem;
    margin: 0.3rem 0.35rem;
    font-size: 0.875rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    transition: all 0.2s ease;
  }

  .tag:hover {
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    transform: translateY(-1px);
  }

  /* è¡¨æ ¼ */
  .table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 4px var(--shadow);
  }

  .table th,
  .table td {
    border-bottom: 1px solid var(--line);
    padding: 0.75rem 0.75rem;
    vertical-align: top;
  }

  .table thead th {
    background: var(--th-bg);
    color: var(--th-text);
    font-weight: 700;
    text-align: left;
    font-size: 0.875rem;
    letter-spacing: 0.02em;
  }

  .table tbody tr {
    transition: background-color 0.2s ease;
  }

  .table tbody tr:hover {
    background: var(--surface);
  }

  /* CCI chips - æ”¹è‰¯é¿å…é‡ç–Š */
  .cci-wrap {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .cci {
    min-width: 138px;
    max-width: 180px;
    padding: 0.45rem 0.6rem;
    border: 1px solid var(--line);
    border-radius: 20px;
    background: var(--card-bg);
    color: var(--ink);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  /* è¼”åŠ©å·¥å…· */
  .helper h2 {
    margin: 0.2rem 0 0.5rem;
  }

  .helper .card {
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 0.75rem;
    margin: 0.6rem 0;
  }

  .tool a {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
    text-decoration: none;
    color: var(--ink);
    border: 2px solid var(--line);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    background: var(--surface);
    transition: all 0.2s ease;
    font-size: 0.9375rem;
  }

  .tool a:hover {
    background: var(--brand-50);
    border-color: var(--brand);
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .pop {
    font-size: 0.85rem;
    color: #1e3a8a;
  }

  /* ========================================
     é é¢æ¨™é ­
     ======================================== */
  header {
    padding: 20px 0 12px 0;
    margin-bottom: 20px;
  }

  header .container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
  }

  header h1 {
    flex: 1;
    min-width: 200px;
    margin: 0;
    background: linear-gradient(135deg, var(--brand) 0%, #2563eb 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2rem;
  }

  /* éŸ¿æ‡‰å¼èª¿æ•´ï¼ˆCGA å°ˆå±¬ï¼‰ */
  @media (max-width: 768px) {
    header .container {
      gap: 12px;
    }
    
    header {
      padding-bottom: 8px;
      margin-bottom: 16px;
    }

    .panel {
      padding: 16px;
    }

    #stepbar {
      gap: 8px;
      margin-bottom: 1rem;
    }

    .step {
      padding: 6px 12px;
      font-size: 0.8125rem;
    }
  }
</style>
</head>
<body>
<header>
  <div class="container">
    <h1>ç¶œåˆè€å¹´è©•ä¼°ï¼ˆCGAï¼‰â€” ä¿®æ­£ç‰ˆ</h1>
    <button class="btn" type="button" id="themeToggle" title="åˆ‡æ›ä¸»é¡Œ">
      <span id="themeIcon">ğŸŒ™</span>
    </button>
  </div>
</header>

<main class="container grid cols-2">
  <!-- LEFT -->
  <section class="panel">
    <div id="stepbar"></div>

    <!-- 1 åŸºæœ¬è³‡æ–™ -->
    <div class="page" data-title="åŸºæœ¬è³‡æ–™">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 2 å€‹äººå² / å®¶ç³»åœ– / é‡å¤§ç–¾ç—… / åŠŸèƒ½å›é¡§ / è·Œå€’è¨˜äº‹ -->
    <div class="page" data-title="å€‹äººå²/å®¶ç³»åœ–/åŠŸèƒ½å›é¡§">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 3 ADL -->
    <div class="page" data-title="ADLï¼ˆBarthelï¼‰">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 4 IADL -->
    <div class="page" data-title="IADLï¼ˆLawtonï¼‰">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 5 Mini-Cog + CDT + MMSE -->
    <div class="page" data-title="Mini-Cog / MMSE">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 6 MoCA -->
    <div class="page" data-title="MoCA">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 7 GDS-5 / CAM / Braden -->
    <div class="page" data-title="GDS-5 / CAM / Braden">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 8 ç‡Ÿé¤Š -->
    <div class="page" data-title="ç‡Ÿé¤Šï¼ˆMNA-SFï¼‰">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 9 è¡Œå‹•/è‚Œå°‘ -->
    <div class="page" data-title="è¡Œå‹•/è‚Œå°‘ï¼ˆCHSï¼‰">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 10 è·Œå€’è©•ä¼° -->
    <div class="page" data-title="è·Œå€’è©•ä¼°ï¼ˆSTRATIFY / Morseï¼‰">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 11 B9 EQ-5D-3L / VAS -->
    <div class="page" data-title="B9 ç”Ÿæ´»å“è³ªï¼ˆEQ-5D-3L / VASï¼‰">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 12 B11 åš´é‡åº¦æŒ‡æ•¸ -->
    <div class="page" data-title="B11 åš´é‡åº¦æŒ‡æ•¸">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 13 CCI -->
    <div class="page" data-title="CCI å…±ç—…æŒ‡æ•¸">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 14 å‡ºé™¢ç‹€æ³ -->
    <div class="page" data-title="å‡ºé™¢ç‹€æ³">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <!-- 15 æ‘˜è¦/è¼¸å‡º -->
    <div class="page" data-title="æ‘˜è¦ / åŒ¯å‡º">
      <!-- è¡¨å–®å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
    </div>

    <div class="controls" style="justify-content:space-between">
      <button class="btn" id="prev">â† ä¸Šä¸€æ­¥</button>
      <div class="hint" id="stepLabel"></div>
      <button class="btn primary" id="next">ä¸‹ä¸€æ­¥ â†’</button>
    </div>
  </section>

  <!-- RIGHTï¼šå·¥å…· -->
  <aside class="panel helper">
    <h2>ğŸ”— å·¥å…·èˆ‡è³‡æº</h2>
    
    <!-- é‡è¡¨ç¶²ç«™ -->
    <div class="card">
      <h3 style="font-size: 1rem; font-weight: 700; color: var(--brand); margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--line);">
        ğŸ“š é‡è¡¨å®˜æ–¹ç¶²ç«™
      </h3>
      
      <div style="display: flex; flex-direction: column; gap: 0.5rem;">
        <!-- èªçŸ¥è©•ä¼°å·¥å…· -->
        <div style="margin-bottom: 0.75rem;">
          <div style="font-size: 0.8125rem; font-weight: 600; color: var(--muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
            ğŸ§  èªçŸ¥è©•ä¼°
          </div>
          <div class="tool">
            <a href="https://www.mocatest.org/" target="_blank" rel="noopener">
              <span style="font-weight: 600;">MoCA</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">å®˜æ–¹ç¶²ç«™</span>
            </a>
          </div>
          <div class="tool">
            <a href="https://www.parinc.com/Products/Pkey/238" target="_blank" rel="noopener">
              <span style="font-weight: 600;">MMSE</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">PAR Inc</span>
            </a>
          </div>
          <div class="tool">
            <a href="https://mini-cog.com" target="_blank" rel="noopener">
              <span style="font-weight: 600;">Mini-Cog</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">ä½¿ç”¨æŒ‡å—</span>
            </a>
          </div>
        </div>
        
        <!-- ç²¾ç¥å¿ƒç†å·¥å…· -->
        <div style="margin-bottom: 0.75rem;">
          <div style="font-size: 0.8125rem; font-weight: 600; color: var(--muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
            ğŸ§˜ ç²¾ç¥ç‹€æ…‹
          </div>
          <div class="tool">
            <a href="https://www.icudelirium.org/medical-professionals/delirium/monitoring-delirium/cam-icudelirium" target="_blank" rel="noopener">
              <span style="font-weight: 600;">CAM</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">è­«å¦„è©•ä¼°</span>
            </a>
          </div>
          <div class="tool">
            <a href="https://www.stanford.edu/~yesavage/GDS.html" target="_blank" rel="noopener">
              <span style="font-weight: 600;">GDS</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">è€å¹´æ†‚é¬±</span>
            </a>
          </div>
        </div>
        
        <!-- åŠŸèƒ½èˆ‡é¢¨éšªå·¥å…· -->
        <div>
          <div style="font-size: 0.8125rem; font-weight: 600; color: var(--muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
            âš•ï¸ åŠŸèƒ½è©•ä¼°
          </div>
          <div class="tool">
            <a href="https://www.mna-elderly.com" target="_blank" rel="noopener">
              <span style="font-weight: 600;">MNA-SF</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">ç‡Ÿé¤Šç¯©æª¢</span>
            </a>
          </div>
          <div class="tool">
            <a href="https://www.cdc.gov/steadi/pdf/TUG_Test-print.pdf" target="_blank" rel="noopener">
              <span style="font-weight: 600;">TUG</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">æ­¥æ…‹å¹³è¡¡</span>
            </a>
          </div>
          <div class="tool">
            <a href="https://www.mdcalc.com/calc/3916/braden-scale-pressure-ulcer-risk" target="_blank" rel="noopener">
              <span style="font-weight: 600;">Braden</span>
              <span style="font-size: 0.8125rem; color: var(--muted); background: var(--surface-secondary); padding: 0.125rem 0.5rem; border-radius: 4px;">å£“å‚·é¢¨éšª</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </aside>
</main>

<!-- Flowbite JS (æœ¬åœ°åŒ–) -->
<script src="../tools/flowbite.min.js"></script>

<!-- Datepicker åˆå§‹åŒ–æ¨¡çµ„ï¼ˆåŒ…å«ä¸­æ–‡åŒ–åŠŸèƒ½ï¼‰ -->
<script src="../tools/date-picker-helper.js"></script>

<!-- äº‹ä»¶ç¸½ç·š - æ¨¡çµ„é–“é€šè¨Š -->
<script src="../tools/event-bus.js"></script>

<!-- è‡ªå‹•è·³åˆ°ä¸‹ä¸€æ¬„å·¥å…· -->
<script src="../tools/auto-next-field.js"></script>

<!-- é¸æ“‡é¡Œå¡ç‰‡å»ºæ§‹å™¨ -->
<script src="../tools/choice-card-builder.js"></script>

<!-- ä¸‹æ‹‰é¸å–®å»ºæ§‹å™¨ -->
<script src="../tools/dropdown-builder.js"></script>

<!-- è¨Šæ¯æ¡†å»ºæ§‹å™¨ -->
<script src="../tools/message-box-builder.js"></script>

<!-- CGA è¡¨å–®æ¨¡çµ„è¼‰å…¥å™¨ï¼ˆå¿…é ˆåœ¨ä¸»è…³æœ¬ä¹‹å‰è¼‰å…¥ï¼‰ -->
<script src="cga-module-loader.js"></script>

<script>
(() => {
  // ========================================
  // å…¨åŸŸè®Šæ•¸
  // ========================================
  const pages = [...document.querySelectorAll('.page')];
  let step = 0;
  const stepbar = document.getElementById('stepbar');
  
  // ä½¿ç”¨ Form 02 æä¾›çš„ç®¡ç†å™¨å·¥å» æ–¹æ³•
  let fam, fall;

  // ========================================
  // é é¢å°èˆª
  // ========================================
  function renderSteps() {
    stepbar.innerHTML = '';
    pages.forEach((p, i) => {
      const b = document.createElement('button');
      b.className = 'step' + (i === step ? ' active' : '');
      b.textContent = (i + 1) + '. ' + p.dataset.title;
      b.onclick = () => show(i);
      stepbar.appendChild(b);
    });
    document.getElementById('stepLabel').textContent = 
      `ç¬¬ ${step + 1}/${pages.length} æ­¥ï¼š${pages[step].dataset.title}`;
  }

  async function show(i) {
    if (i < 0 || i >= pages.length) return;
    
    console.log(`ğŸ“ åˆ‡æ›åˆ°é é¢ ${i + 1}ï¼š${pages[i].dataset.title}`);
    
    // åˆ‡æ›é¡¯ç¤ºï¼ˆæ¨¡çµ„å·²é å…ˆè¼‰å…¥ï¼‰
    pages.forEach((p, idx) => p.classList.toggle('show', idx === i));
    step = i;
    renderSteps();
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // æ¯æ¬¡åˆ‡æ›é é¢æ™‚ç¶å®šäº‹ä»¶å’Œé‡æ–°è¨ˆç®—
    bindAllEvents();
    recomputeAll();
    
    console.log(`âœ… é é¢åˆ‡æ›å®Œæˆ`);
  }

  document.getElementById('prev').onclick = () => show(step - 1);
  document.getElementById('next').onclick = () => show(step + 1);

  // ========================================
  // å·¥å…·å‡½æ•¸
  // ========================================
  const $ = (s, root = document) => root.querySelector(s);
  const $$ = (s, root = document) => Array.from(root.querySelectorAll(s));
  const nv = (el) => (el?.value ?? '').trim();
  const num = (el) => {
    const v = parseFloat(nv(el));
    return Number.isFinite(v) ? v : null;
  };
  const tag = (wrap, txt) => {
    const t = document.createElement('span');
    t.className = 'tag';
    t.textContent = txt;
    wrap.appendChild(t);
  };

  // ========================================
  // è³‡æ–™æ‘˜è¦èˆ‡è¨ˆç®—
  // ========================================
  function recomputeAll() {
    // èª¿ç”¨ Form 01 çš„ BMI è¨ˆç®—
    if (window.CGAForm01 && typeof window.CGAForm01.syncAnthro === 'function') {
      window.CGAForm01.syncAnthro();
    }
    
    // èª¿ç”¨å„æ¨¡çµ„çš„è¨ˆç®—æ–¹æ³•
    const modules = [
      'CGAForm03', 'CGAForm04', 'CGAForm05', 'CGAForm06',
      'CGAForm07', 'CGAForm08', 'CGAForm09', 'CGAForm10',
      'CGAForm11', 'CGAForm12', 'CGAForm13'
    ];
    
    modules.forEach(moduleName => {
      if (window[moduleName] && typeof window[moduleName].compute === 'function') {
        window[moduleName].compute();
      }
    });
    
    // æ¨™ç±¤ï¼ˆåªåœ¨æ‘˜è¦é å­˜åœ¨æ™‚åŸ·è¡Œï¼‰
    const box = $('#riskTags');
    if (!box) return;
    
    box.innerHTML = '';
    
    // å®‰å…¨è®€å–å…ƒç´ ï¼ˆé¿å… null éŒ¯èª¤ï¼‰
    const safeText = (selector) => {
      const el = $(selector);
      return el ? (el.textContent || '0') : '0';
    };
    
    // é¢¨éšªæ¨™ç±¤
    const gds = +safeText('#gdsTotal');
    if (gds >= 2) tag(box, 'GDS-5 â‰¥2');
    
    const cam = nv($('#camResult'));
    if (cam === 'è­«å¦„') tag(box, 'CAM è­«å¦„');
    
    const br = +safeText('#bradenTotal');
    if (br && br <= 12) tag(box, 'Braden é«˜é¢¨éšª');
    
    const mna = +safeText('#mnaTotal');
    if (mna <= 7) tag(box, 'MNA-SF ç‡Ÿé¤Šä¸è‰¯');
    else if (mna <= 11) tag(box, 'MNA-SF é¢¨éšª');
    
    const chs = +safeText('#chsTotal');
    if (chs >= 3) tag(box, 'CHS è¡°å¼±');
    else if (chs >= 1) tag(box, 'CHS å‰è¡°å¼±');
    
    const morse = +safeText('#morseTotal');
    if (morse >= 46) tag(box, 'Morse â‰¥46 é«˜è·Œå€’é¢¨éšª');
    
    const mmse = +safeText('#mmseTotal');
    if (mmse && mmse <= 23) tag(box, 'MMSE â‰¤23');
    
    const moca = +safeText('#mocaTotal');
    if (moca && moca < 26) tag(box, 'MoCA <26');
    
    const adl = +safeText('#adlTotal');
    if (adl <= 60) tag(box, 'ADL â‰¤60');
    
    const cci = +safeText('#cciTotal');
    if (cci >= 5) tag(box, 'CCI â‰¥5');
    
    // æ‘˜è¦æ–‡å­—
    const nm = nv($('#pname')) || 'å€‹æ¡ˆ';
    const age = nv($('#age')) || '?';
    const sex = nv($('#sex')) || '';
    const iadlTotal = safeText('#iadlTotal');
    const iadlMax = safeText('#iadlMax');
    const stratifyTotal = safeText('#stratifyTotal');
    
    const sum = `${nm}ï¼ˆ${age}æ­²${sex}ï¼‰ã€‚ADL ${adl}/100ï¼›IADL ${iadlTotal}/${iadlMax}ï¼›Mini-Cog ${$('#miniTotal')?.value || 'NA'}/5ï¼ˆ${nv($('#miniBinary')) || 'NA'}ï¼‰ï¼›MMSE ${mmse || 'NA'}/30ï¼›MoCA ${moca || 'NA'}/30ï¼›GDS-5 ${gds}/5ï¼›MNA-SF ${mna}/14ï¼›æ­¥é€Ÿ ${nv($('#gaitSpeed')) || 'NA'} m/sï¼›TUG ${nv($('#tug')) || 'NA'} sï¼›æ¡åŠ›æœ€å¤§ ${nv($('#gripMax')) || 'NA'} kgï¼›CFS ${nv($('#cfs')) || 'NA'}ï¼›STRATIFY ${stratifyTotal}ï¼›Morse ${morse}ï¼›EQ-VAS ${nv($('#eqVASVal')) || 'NA'}ï¼›CCI ${cci}ï¼›å‡ºé™¢ï¼š${nv($('#dcDest')) || 'NA'}ã€‚`;
    
    const summaryEl = $('#summary');
    if (summaryEl) summaryEl.value = sum;
  }

  // ========================================
  // è³‡æ–™å„²å­˜èˆ‡åŒ¯å‡º
  // ========================================
  function snapshot() {
    const data = {};
    
    $$('input, select, textarea').forEach(el => {
      const key = el.id || el.name || el.getAttribute('data-k');
      if (!key) return;
      
      if (el.type === 'radio') {
        if (el.checked) data[key] = el.value;
      } else if (el.type === 'checkbox') {
        data[key] = el.checked;
      } else {
        data[key] = el.value;
      }
    });
    
    data['fam'] = JSON.stringify(fam.rows);
    data['falls'] = JSON.stringify(fall.list);
    
    return data;
  }

  function loadshot(obj) {
    $$('input, select, textarea').forEach(el => {
      const key = el.id || el.name || el.getAttribute('data-k');
      if (!(key in obj)) return;
      
      if (el.type === 'checkbox') {
        el.checked = !!obj[key];
      } else if (el.type === 'radio') {
        if (el.value == obj[key]) el.checked = true;
      } else {
        el.value = obj[key];
      }
    });
    
    try {
      fam.rows = JSON.parse(obj.fam || '[]');
    } catch {}
    
    try {
      fall.list = JSON.parse(obj.falls || '[]');
    } catch {}
    
    fam.render();
    fall.render();
    recomputeAll();
  }

  // ========================================
  // çµ±ä¸€äº‹ä»¶ç¶å®š
  // ========================================
  function bindAllEvents() {
    // åˆå§‹åŒ–æ‰€æœ‰å·²è¼‰å…¥çš„å‹•æ…‹è¡¨å–®æ¨¡çµ„
    const formModules = [
      'CGAForm01', 'CGAForm02', 'CGAForm03', 'CGAForm04',
      'CGAForm06', 'CGAForm07', 'CGAForm08', 'CGAForm09', 'CGAForm10',
      'CGAForm11', 'CGAForm13', 'CGAForm14', 'CGAForm15'
    ];
    
    formModules.forEach(moduleName => {
      if (window[moduleName] && typeof window[moduleName].initialize === 'function') {
        window[moduleName].initialize();
      }
    });
  }
  
  // ========================================
  // äº‹ä»¶è¨‚é–± - ç›£è½æ¨¡çµ„ç™¼é€çš„äº‹ä»¶
  // ========================================
  function subscribeToEvents() {
    if (!window.CGAEventBus) {
      console.warn('âš ï¸ äº‹ä»¶ç¸½ç·šå°šæœªåˆå§‹åŒ–');
      return;
    }
    
    // è¨‚é–±å®¶ç³»åœ–æ–°å¢äº‹ä»¶
    window.CGAEventBus.on('family:add', (data) => {
      if (!data.role) return alert('è«‹é¸è§’è‰²');
      
      fam.rows.push(data);
      fam.render();
      
      // é€šçŸ¥æ¨¡çµ„æ¸…ç©ºè¡¨å–®
      window.CGAEventBus.emit('family:added', { success: true });
    });
    
    // è¨‚é–±è·Œå€’è¨˜éŒ„æ–°å¢äº‹ä»¶
    window.CGAEventBus.on('fall:add', (data) => {
      if (!data.date && !data.place) return alert('è«‹è‡³å°‘å¡« æ—¥æœŸæˆ–åœ°é»');
      
      fall.list.push(data);
      fall.render();
      
      // é€šçŸ¥æ¨¡çµ„æ¸…ç©ºè¡¨å–®
      window.CGAEventBus.emit('fall:added', { success: true });
    });
    
    // è¨‚é–±é‡æ–°è¨ˆç®—äº‹ä»¶
    window.CGAEventBus.on('summary:recalc', () => {
      recomputeAll();
    });
    
    // è¨‚é–±å„²å­˜äº‹ä»¶
    window.CGAEventBus.on('summary:save', () => {
      localStorage.setItem('cga_full', JSON.stringify(snapshot()));
      alert('âœ… å·²å„²å­˜');
    });
    
    // è¨‚é–±è¼‰å…¥äº‹ä»¶
    window.CGAEventBus.on('summary:load', () => {
      const raw = localStorage.getItem('cga_full');
      if (!raw) return alert('âš ï¸ å°šç„¡è³‡æ–™');
      loadshot(JSON.parse(raw));
      alert('âœ… å·²è¼‰å…¥');
    });
    
    // è¨‚é–±æ¸…é™¤äº‹ä»¶
    window.CGAEventBus.on('summary:clear', () => {
      if (confirm('âš ï¸ æ¸…é™¤æ‰€æœ‰å…§å®¹ï¼Ÿ')) {
        localStorage.removeItem('cga_full');
        localStorage.removeItem('cga_autosave');
        location.reload();
      }
    });
    
    // è¨‚é–±åŒ¯å‡º JSON äº‹ä»¶
    window.CGAEventBus.on('summary:exportJson', () => {
      const blob = new Blob([JSON.stringify(snapshot(), null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `cga_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
    });
    
    // è¨‚é–±åŒ¯å‡º CSV äº‹ä»¶
    window.CGAEventBus.on('summary:exportCsv', () => {
      const obj = snapshot();
      const keys = Object.keys(obj);
      const row = keys.map(k => JSON.stringify(obj[k] ?? '')).join(',');
      const csv = keys.join(',') + '\n' + row + '\n';
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
      a.download = `cga_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    });
    
    console.log('âœ… äº‹ä»¶è¨‚é–±å®Œæˆ');
  }

  // ========================================
  // å…¨åŸŸäº‹ä»¶ç›£è½
  // ========================================
  document.addEventListener('change', recomputeAll, true);
  document.addEventListener('input', recomputeAll, true);

  // ========================================
  // æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
  // ========================================
  (async function init() {
    renderSteps();
    
    // åˆå§‹åŒ–å®¶ç³»åœ–å’Œè·Œå€’è¨˜éŒ„ç®¡ç†å™¨ï¼ˆä½¿ç”¨ Form 02 æä¾›çš„å·¥å» æ–¹æ³•ï¼‰
    if (window.CGAForm02) {
      fam = window.CGAForm02.constructor.createFamilyManager();
      fall = window.CGAForm02.constructor.createFallManager();
    } else {
      // å¦‚æœæ¨¡çµ„å°šæœªè¼‰å…¥ï¼Œä½¿ç”¨è‡¨æ™‚ç‰©ä»¶
      fam = { rows: [], render: () => {} };
      fall = { list: [], render: () => {} };
    }
    
    // è¨‚é–±äº‹ä»¶ï¼ˆåœ¨æ¨¡çµ„è¼‰å…¥å‰ï¼‰
    subscribeToEvents();
    
    // ç¢ºä¿ CGAModuleLoader å·²è¼‰å…¥
    if (!window.CGAModuleLoader) {
      console.error('âŒ CGAModuleLoader å°šæœªè¼‰å…¥ï¼');
      alert('è¼‰å…¥å™¨åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
      return;
    }
    
    console.log('ğŸš€ é–‹å§‹é å…ˆè¼‰å…¥æ‰€æœ‰è¡¨å–®æ¨¡çµ„...');
    
    // é å…ˆè¼‰å…¥æ‰€æœ‰ 15 å€‹è¡¨å–®æ¨¡çµ„
    const totalModules = pages.length;
    for (let i = 0; i < totalModules; i++) {
      try {
        console.log(`ğŸ“¦ è¼‰å…¥æ¨¡çµ„ ${i + 1}/${totalModules}...`);
        await window.CGAModuleLoader.loadModule(i);
        console.log(`âœ… æ¨¡çµ„ ${i + 1} è¼‰å…¥å®Œæˆ`);
      } catch (error) {
        console.error(`âŒ è¼‰å…¥æ¨¡çµ„ ${i + 1} å¤±æ•—:`, error);
        // ç¹¼çºŒè¼‰å…¥å…¶ä»–æ¨¡çµ„ï¼Œä¸ä¸­æ–·
      }
    }
    
    console.log('âœ… æ‰€æœ‰è¡¨å–®æ¨¡çµ„è¼‰å…¥å®Œæˆï¼');
    
    // é¡¯ç¤ºç¬¬ä¸€å€‹é é¢
    pages.forEach((p, idx) => p.classList.toggle('show', idx === 0));
    step = 0;
    renderSteps();
    
    // ç¶å®šæ‰€æœ‰äº‹ä»¶
    bindAllEvents();
    recomputeAll();
    
    // è‡ªå‹•æ¢å¾©æš«å­˜è³‡æ–™
    const autoSaved = localStorage.getItem('cga_autosave');
    if (autoSaved) {
      try {
        loadshot(JSON.parse(autoSaved));
        console.log('âœ… å·²è‡ªå‹•æ¢å¾©æš«å­˜è³‡æ–™');
      } catch (e) {
        console.error('âŒ æ¢å¾©æš«å­˜è³‡æ–™å¤±æ•—:', e);
      }
    }
    
    // å»ºç«‹è‡ªå‹•æš«å­˜æç¤ºå…ƒç´ ï¼ˆå³ä¸‹è§’ï¼‰
    const autoSaveToast = document.createElement('div');
    autoSaveToast.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 0.75rem 1rem;
      background: var(--brand);
      color: white;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 9999;
    `;
    autoSaveToast.textContent = 'ğŸ’¾ å·²è‡ªå‹•æš«å­˜';
    document.body.appendChild(autoSaveToast);
    
    // è‡ªå‹•æš«å­˜åŠŸèƒ½ï¼ˆé˜²æŠ– 2 ç§’ï¼‰
    let autoSaveTimer = null;
    let toastTimer = null;
    function autoSave() {
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        try {
          localStorage.setItem('cga_autosave', JSON.stringify(snapshot()));
          
          // é¡¯ç¤ºæç¤ºï¼ˆ1.5 ç§’å¾Œè‡ªå‹•æ¶ˆå¤±ï¼‰
          autoSaveToast.style.opacity = '1';
          clearTimeout(toastTimer);
          toastTimer = setTimeout(() => {
            autoSaveToast.style.opacity = '0';
          }, 1500);
        } catch (e) {
          console.error('âŒ è‡ªå‹•æš«å­˜å¤±æ•—:', e);
        }
      }, 2000);
    }
    
    // ç›£è½æ‰€æœ‰è¡¨å–®è®Šæ›´
    document.addEventListener('input', autoSave, true);
    document.addEventListener('change', autoSave, true);
    
    console.log('âœ… åˆå§‹åŒ–å®Œæˆï¼ˆå·²å•Ÿç”¨è‡ªå‹•æš«å­˜ï¼‰');
  })();

  // ========================================
  // ä¸»é¡Œåˆ‡æ›åŠŸèƒ½
  // ========================================
  const themeToggle = document.getElementById('themeToggle');
  const themeIcon = document.getElementById('themeIcon');
  const htmlElement = document.documentElement;
  
  // åŒæ­¥ä¸»é¡Œåœ–ç¤ºï¼ˆä¸»é¡Œå·²åœ¨ <head> ä¸­å¥—ç”¨ï¼‰
  const currentTheme = htmlElement.getAttribute('data-theme');
  if (themeIcon) {
    themeIcon.textContent = currentTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
  }
  
  // ä¸»é¡Œåˆ‡æ›äº‹ä»¶
  if (themeToggle) {
    themeToggle.addEventListener('click', () => {
      const currentTheme = htmlElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      // æ›´æ–°è‡ªè¨‚å±¬æ€§
      htmlElement.setAttribute('data-theme', newTheme);
      
      // æ›´æ–° Flowbite éœ€è¦çš„ dark class
      if (newTheme === 'dark') {
        htmlElement.classList.add('dark');
      } else {
        htmlElement.classList.remove('dark');
      }
      
      themeIcon.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
      // ä½¿ç”¨èˆ‡ index.html ç›¸åŒçš„ keyï¼Œå¯¦ç¾è·¨é é¢ä¸»é¡Œè¨˜æ†¶
      localStorage.setItem('theme', newTheme);
    });
  }
})();
</script>

</body>
</html>
